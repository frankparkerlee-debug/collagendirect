<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Register — Physician Portal | CollagenDirect</title>
  <meta name="description" content="Create a secure CollagenDirect physician account to access ordering, documentation, and patient workflows." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#fafafa; --text:#1e2a38; --muted:#6b7280; --line:#e5e7eb;
      --brand:#5FA8A1; --brand-hover:#4d8d87;
      --radius:12px; --shadow:0 1px 3px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background: linear-gradient(to bottom right, #f8fafc 0%, #ffffff 50%, rgba(71, 198, 190, 0.03) 100%);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    img{max-width:100%;display:block}
    a{text-decoration:none;color:inherit}
    .container{max-width:1200px;margin:0 auto;padding:0 1.5rem}

    /* Simple header */
    header{
      background:#fff;
      border-bottom:1px solid var(--line);
      padding:1rem 0;
    }
    .nav{
      max-width:1200px;
      margin:0 auto;
      padding:0 1.5rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:32px;width:auto}
    .brand .title{font-weight:700;font-size:1rem;letter-spacing:.3px}

    /* Main content area */
    main{
      flex:1;
      padding:3rem 0;
    }
    .auth-card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:2.5rem;
      box-shadow:0 4px 6px -1px rgba(0,0,0,.05),0 2px 4px -1px rgba(0,0,0,.03);
      max-width:900px;
      margin:0 auto;
    }
    .auth-card h2{
      font-size:1.75rem;
      font-weight:700;
      color:#111;
      margin-bottom:0.5rem;
    }
    .muted{color:var(--muted)}
    .section-title{
      font-size:1.125rem;
      font-weight:600;
      color:#374151;
      margin-top:2rem;
      margin-bottom:1rem;
      padding-bottom:0.5rem;
      border-bottom:1px solid var(--line);
    }

    /* Form styling */
    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:1rem;
      margin-top:1rem;
    }
    .form-grid > div{
      display:flex;
      flex-direction:column;
      gap:0.5rem;
    }
    .form-grid.single{grid-template-columns:1fr}

    /* Inputs */
    .auth-card input,.auth-card select,.auth-card textarea{
      width:100%;
      padding:0.75rem 1rem;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      outline:none;
      font-size:0.95rem;
      transition:border-color 0.2s,box-shadow 0.2s;
    }
    .auth-card input::placeholder{color:#9ca3af}
    .auth-card input:focus,.auth-card select:focus,.auth-card textarea:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(95,168,161,.1);
    }
    label{
      display:block;
      font-weight:500;
      font-size:0.875rem;
      color:#374151;
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:0.875rem;
    }
    .row a{
      color:var(--brand);
      text-decoration:none;
      font-weight:500;
    }
    .row a:hover{text-decoration:underline}

    /* Buttons */
    .btn{
      padding:0.75rem 1.5rem;
      border-radius:var(--radius);
      font-weight:600;
      font-size:0.95rem;
      cursor:pointer;
      border:1px solid var(--line);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s;
      background:#fff;
      color:#374151;
    }
    .btn:hover{
      background:#f9fafb;
    }
    .btn.primary{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    .btn.primary:hover{
      background:var(--brand-hover);
    }
    .btn.ghost{
      background:#fff;
      border:1px solid var(--line);
      color:#374151;
    }
    .btn.ghost:hover{
      background:#f9fafb;
    }
    .btn.secondary{
      background:#f3f4f6;
      border:1px solid var(--line);
      color:#374151;
    }
    .btn.small{
      padding:0.5rem 1rem;
      font-size:0.875rem;
    }

    /* Status indicators */
    .status{
      padding:0.5rem 0.75rem;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:#fff;
      font-size:0.875rem;
    }
    .status.ok{
      border-color:#d1fae5;
      background:#ecfdf5;
      color:#065f46;
    }
    .status.bad{
      border-color:#fecaca;
      background:#fef2f2;
      color:#991b1b;
    }

    /* Fieldset styling */
    fieldset{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:1.5rem;
      margin-top:1rem;
    }
    legend{
      padding:0 0.5rem;
      font-weight:600;
      color:#374151;
    }

    /* User type selection cards */
    .user-type-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:1rem;
      margin-top:1rem;
    }
    .user-type-card{
      border:2px solid var(--line);
      border-radius:var(--radius);
      padding:1.5rem;
      cursor:pointer;
      transition:all 0.2s;
      background:#fff;
    }
    .user-type-card:hover{
      border-color:var(--brand);
      background:#f0fdfb;
    }
    .user-type-card input[type="radio"]{
      display:none;
    }
    .user-type-card input[type="radio"]:checked + .card-content{
      border-left:4px solid var(--brand);
      padding-left:1rem;
    }
    .user-type-card.selected{
      border-color:var(--brand);
      background:#f0fdfb;
    }
    .card-content h3{
      font-size:1rem;
      font-weight:600;
      color:#111;
      margin-bottom:0.5rem;
    }
    .card-content p{
      font-size:0.875rem;
      color:var(--muted);
    }

    /* Physician item in "Add More" list */
    .physician-item{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:1rem;
      margin-top:0.75rem;
      background:#f9fafb;
      position:relative;
    }
    .physician-item-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:0.75rem;
    }
    .physician-item-header h4{
      font-size:0.95rem;
      font-weight:600;
      color:#374151;
    }
    .btn-remove{
      background:#fee;
      border:1px solid #fecaca;
      color:#991b1b;
      padding:0.25rem 0.75rem;
      font-size:0.8rem;
      border-radius:8px;
      cursor:pointer;
      font-weight:500;
    }
    .btn-remove:hover{
      background:#fecaca;
    }

    /* Footer */
    footer{
      background:#fff;
      border-top:1px solid var(--line);
      padding:1rem;
      text-align:center;
      color:var(--muted);
      font-size:0.875rem;
    }

    /* Utility classes */
    [hidden]{display:none !important}

    /* Field validation styles */
    .field-error input,
    .field-error select{
      border-color:#dc2626 !important;
      background:#fef2f2;
    }
    .field-error input:focus,
    .field-error select:focus{
      border-color:#dc2626 !important;
      box-shadow:0 0 0 3px rgba(220,38,38,.1) !important;
    }
    .error-message{
      color:#dc2626;
      font-size:0.875rem;
      margin-top:0.25rem;
      display:none;
    }
    .field-error .error-message{
      display:block;
    }
    .validation-summary{
      background:#fef2f2;
      border:1px solid #fecaca;
      border-radius:var(--radius);
      padding:1rem;
      margin-bottom:1.5rem;
      display:none;
    }
    .validation-summary.show{
      display:block;
    }
    .validation-summary h3{
      color:#991b1b;
      font-size:1rem;
      font-weight:600;
      margin-bottom:0.5rem;
    }
    .validation-summary ul{
      list-style:none;
      padding:0;
      margin:0;
    }
    .validation-summary li{
      color:#991b1b;
      font-size:0.875rem;
      padding:0.25rem 0;
      padding-left:1.5rem;
      position:relative;
    }
    .validation-summary li:before{
      content:"•";
      position:absolute;
      left:0.5rem;
    }

    /* Responsive */
    @media (max-width:768px){
      .form-grid{grid-template-columns:1fr}
      .user-type-grid{grid-template-columns:1fr}
      .auth-card{padding:1.5rem}
      .auth-card h2{font-size:1.5rem}
    }

    /* Modal/Dialog styles */
    .modal-overlay{
      display:none;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.5);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:1rem;
    }
    .modal-overlay.show{
      display:flex;
    }
    .modal-content{
      background:#fff;
      border-radius:16px;
      max-width:900px;
      width:100%;
      max-height:90vh;
      display:flex;
      flex-direction:column;
      box-shadow:0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);
    }
    .modal-header{
      padding:1.5rem 2rem;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .modal-header h2{
      font-size:1.25rem;
      font-weight:700;
      color:#111;
      margin:0;
    }
    .modal-close{
      background:transparent;
      border:none;
      font-size:1.5rem;
      color:var(--muted);
      cursor:pointer;
      padding:0.25rem;
      line-height:1;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
    }
    .modal-close:hover{
      background:#f3f4f6;
      color:#111;
    }
    .modal-body{
      padding:2rem;
      overflow-y:auto;
      flex:1;
      font-size:0.9rem;
      line-height:1.6;
    }
    .modal-body h3{
      font-size:1rem;
      font-weight:600;
      color:#111;
      margin-top:1.5rem;
      margin-bottom:0.75rem;
    }
    .modal-body h3:first-child{
      margin-top:0;
    }
    .modal-body p{
      color:#374151;
      margin-bottom:0.75rem;
    }
    .modal-body ul, .modal-body ol{
      margin-left:1.5rem;
      margin-bottom:0.75rem;
      color:#374151;
    }
    .modal-body li{
      margin-bottom:0.25rem;
    }
    .modal-body strong{
      font-weight:600;
      color:#111;
    }
    .modal-footer{
      padding:1.5rem 2rem;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:flex-end;
      gap:1rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <a href="/index.html" class="brand" aria-label="Go to homepage">
        <img src="/assets/collagendirect.png" alt="CollagenDirect logo">
        <span class="title">COLLAGEN <span style="color:#5FA8A1">DIRECT</span></span>
      </a>
    </div>
  </header>

  <main class="container">
    <section class="auth-card">
      <h2>Create Your Account</h2>
      <p class="muted">Already have an account? <a href="/portal" style="color:var(--brand);font-weight:500">Sign in</a></p>

      <form id="registerForm" novalidate action="javascript:void(0)">

        <!-- Validation Summary -->
        <div id="validationSummary" class="validation-summary">
          <h3>Please correct the following errors:</h3>
          <ul id="validationList"></ul>
        </div>

        <!-- Step 1: User Type Selection -->
        <section class="card" style="border:none;box-shadow:none;padding:0">
          <h2 class="section-title" style="margin:0 0 8px">Select Your Account Type</h2>
          <p class="muted" style="margin-bottom:1rem">Choose the option that best describes your practice</p>

          <div class="user-type-grid">
            <!-- 1a. Practice Manager / Admin (Non-DME) -->
            <label class="user-type-card" data-type="practice_admin">
              <input type="radio" name="userType" value="practice_admin" required />
              <div class="card-content">
                <h3>Practice Manager / Admin</h3>
                <p>Manage practice details, physicians, and refer patients. No DME license required.</p>
              </div>
            </label>

            <!-- 1b. Physician (Non-DME, part of practice) -->
            <label class="user-type-card" data-type="physician">
              <input type="radio" name="userType" value="physician" />
              <div class="card-content">
                <h3>Physician</h3>
                <p>Join an existing practice. Sign orders for your own patients.</p>
              </div>
            </label>

            <!-- 2a. DME Hybrid Referrer -->
            <label class="user-type-card" data-type="dme_hybrid">
              <input type="radio" name="userType" value="dme_hybrid" />
              <div class="card-content">
                <h3>DME Hybrid Referrer</h3>
                <p>Hold a DME license. Mix of referrals and direct billing on a case-by-case basis.</p>
              </div>
            </label>

            <!-- 2b. DME Wholesale Only -->
            <label class="user-type-card" data-type="dme_wholesale">
              <input type="radio" name="userType" value="dme_wholesale" />
              <div class="card-content">
                <h3>DME Wholesale Only</h3>
                <p>Hold a DME license. Direct bill all patients and purchase products wholesale.</p>
              </div>
            </label>
          </div>
        </section>

        <!-- Step 2: Account Credentials -->
        <section class="card" aria-labelledby="acct-title" style="border:none;box-shadow:none;padding:0">
          <h2 id="acct-title" class="section-title">Account Credentials</h2>
          <div class="form-grid">
            <div id="field-email">
              <label for="email">Work Email</label>
              <input id="email" type="email" required placeholder="name@practice.com" />
              <div class="error-message">Please enter a valid email address</div>
              <div class="muted" style="font-size:.9rem">Used for login and agreement copies</div>
            </div>
            <div id="field-password">
              <label for="password">Password</label>
              <input id="password" type="password" minlength="8" required placeholder="••••••••" />
              <div class="error-message">Password must be at least 8 characters</div>
              <div class="muted" style="font-size:.9rem">Min 8 characters, include a number</div>
            </div>
          </div>
        </section>

        <!-- Step 3: Practice Information (for practice_admin, dme_hybrid, dme_wholesale) -->
        <section id="practiceInfoSection" class="card" aria-labelledby="practice-title" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 id="practice-title" class="section-title">Practice Information</h2>
          <div class="form-grid">
            <div id="field-practiceName">
              <label for="practiceName">Practice / Facility Name</label>
              <input id="practiceName" />
              <div class="error-message">Practice name is required</div>
            </div>
            <div id="field-taxId">
              <label for="taxId">Tax ID (optional)</label>
              <input id="taxId" placeholder="##-#######" />
            </div>
            <div id="field-address">
              <label for="address">Full Address</label>
              <input id="address" placeholder="Start typing address..." />
              <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.25rem;">Address will autocomplete as you type</div>
              <div class="error-message">Address is required</div>
            </div>
            <!-- Hidden fields for structured data storage -->
            <input type="hidden" id="city" />
            <input type="hidden" id="state" />
            <input type="hidden" id="zip" />
            <div id="field-phone">
              <label for="phone">Practice Phone</label>
              <input id="phone" type="tel" placeholder="(555) 555-5555" />
              <div class="error-message">Phone number is required</div>
            </div>
          </div>
        </section>

        <!-- Step 4: Physician Credentials (shown for all types) -->
        <section id="physicianCredsSection" class="card" aria-labelledby="cred-title" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 id="cred-title" class="section-title">Physician Credentials</h2>
          <div class="form-grid">
            <div id="field-firstName">
              <label for="firstName">First Name</label>
              <input id="firstName" />
              <div class="error-message">First name is required</div>
            </div>
            <div id="field-lastName">
              <label for="lastName">Last Name</label>
              <input id="lastName" />
              <div class="error-message">Last name is required</div>
            </div>
            <div id="field-npi">
              <label for="npi">NPI Number</label>
              <input id="npi" inputmode="numeric" pattern="\d{10}" placeholder="10 digits" />
              <div class="error-message">NPI number is required</div>
            </div>
          </div>
          <div class="form-grid" style="margin-top:12px">
            <div id="field-license">
              <label for="license">Medical License #</label>
              <input id="license" />
              <div class="error-message">Medical license is required</div>
            </div>
            <div id="field-licenseState">
              <label for="licenseState">License State</label>
              <select id="licenseState"></select>
              <div class="error-message">License state is required</div>
            </div>
            <div id="field-licenseExpiry">
              <label for="licenseExpiry">License Expiry</label>
              <input id="licenseExpiry" type="date" />
              <div class="error-message">License expiry is required</div>
            </div>
          </div>
          <div class="row" style="margin-top:10px;gap:12px">
            <button type="button" class="btn" id="btnValidateNPI">Validate NPI</button>
            <span id="npiStatus" class="status" aria-live="polite">NPI not validated</span>
          </div>
        </section>

        <!-- Step 5: Additional Physicians (for practice_admin only) -->
        <section id="additionalPhysiciansSection" class="card" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 class="section-title">Additional Physicians (Optional)</h2>
          <p class="muted" style="margin-bottom:1rem">Add other physicians in your practice who will use this portal</p>

          <div id="additionalPhysiciansList"></div>

          <button type="button" class="btn secondary small" id="btnAddPhysician" style="margin-top:1rem">
            + Add Another Physician
          </button>
        </section>

        <!-- Step 6: Practice Manager Link (for physician type only) -->
        <section id="practiceManagerLinkSection" class="card" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 class="section-title">Link to Practice Manager</h2>
          <p class="muted" style="margin-bottom:1rem">Enter your practice manager's email or practice code to link your account</p>
          <div class="form-grid single">
            <div id="field-practiceManagerEmail">
              <label for="practiceManagerEmail">Practice Manager Email</label>
              <input id="practiceManagerEmail" type="email" placeholder="manager@practice.com" />
              <div class="error-message">Practice manager email is required</div>
              <div class="muted" style="font-size:.9rem">Your practice manager will need to approve your access</div>
            </div>
          </div>
        </section>

        <!-- Step 7: DME License Information (for dme_hybrid and dme_wholesale) -->
        <section id="dmeSection" class="card" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 class="section-title">DME License Information</h2>
          <div class="form-grid">
            <div id="field-dmeNumber">
              <label for="dmeNumber">DME License #</label>
              <input id="dmeNumber" />
              <div class="error-message">DME license number is required</div>
            </div>
            <div id="field-dmeState">
              <label for="dmeState">DME State</label>
              <select id="dmeState"></select>
              <div class="error-message">DME state is required</div>
            </div>
            <div id="field-dmeExpiry">
              <label for="dmeExpiry">DME Expiry</label>
              <input id="dmeExpiry" type="date" />
              <div class="error-message">DME expiry date is required</div>
            </div>
          </div>
        </section>

        <!-- Step 8: Agreements & e-Sign -->
        <section id="agreementsSection" class="card" aria-labelledby="agreements-title" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 id="agreements-title" class="section-title">Agreements & e-Sign</h2>
          <div class="form-grid">
            <div id="field-agreeMSA">
              <label>Master Services & Supply Agreement</label>
              <div class="row" style="gap:12px">
                <button type="button" class="btn" data-open="msaa">Preview</button>
                <label class="row" style="gap:8px"><input id="agreeMSA" type="checkbox" /> <span>I agree</span></label>
              </div>
              <div class="error-message">You must agree to the MSA</div>
            </div>
            <div id="field-agreeBAA">
              <label>Business Associate Agreement (BAA)</label>
              <div class="row" style="gap:12px">
                <button type="button" class="btn" data-open="baa">Preview</button>
                <label class="row" style="gap:8px"><input id="agreeBAA" type="checkbox" /> <span>I agree</span></label>
              </div>
              <div class="error-message">You must agree to the BAA</div>
            </div>
          </div>
          <div class="form-grid" style="margin-top:10px">
            <div id="field-signName">
              <label for="signName">Full Legal Name (Signature)</label>
              <input id="signName" />
              <div class="error-message">Signature name is required</div>
            </div>
            <div id="field-signTitle">
              <label for="signTitle">Title</label>
              <input id="signTitle" placeholder="MD, DO, etc." />
              <div class="error-message">Title is required</div>
            </div>
            <div id="field-signDate">
              <label for="signDate">Date</label>
              <input id="signDate" type="date" />
              <div class="error-message">Date is required</div>
            </div>
          </div>
        </section>

        <div class="row" style="margin-top:2rem;gap:12px;flex-wrap:wrap">
          <button id="submitBtn" type="button" class="btn primary">Create Account</button>
          <a class="btn ghost" href="/portal">Already registered? Log in</a>
        </div>

        <p class="muted" style="margin-top:1.5rem;text-align:center;font-size:0.875rem">
          For assistance, contact <a href="mailto:support@collagendirect.health" style="color:var(--brand);font-weight:500">support@collagendirect.health</a>
        </p>
      </form>
    </section>
  </main>

  <footer>
    © <span id="year"></span> CollagenDirect. All rights reserved.
  </footer>

  <!-- BAA Modal -->
  <div id="baaModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Business Associate Agreement (BAA)</h2>
        <button type="button" class="modal-close" data-close="baa" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body" id="baaContent">
        <p><strong>COLLAGEN DIRECT BUSINESS ASSOCIATE AGREEMENT</strong></p>

        <p>This Business Associate Agreement ("Agreement") is entered into by and between:</p>
        <p>The "Covered Entity," defined below, and</p>
        <p>CollagenDirect ("Business Associate"),</p>

        <p>and is effective as of the date the Covered Entity (or its authorized representative) creates or is provisioned with an account on the CollagenDirect Provider Portal and affirmatively accepts this Agreement (the "Effective Date").</p>

        <p>By creating or activating an account in the CollagenDirect Provider Portal, the individual submitting registration represents and warrants that they (a) are authorized to bind the Covered Entity (e.g. physician practice, clinic, facility) to this Agreement, and (b) are entering this Agreement on behalf of that Covered Entity. The Parties enter this Agreement to comply with the Health Insurance Portability and Accountability Act of 1996 ("HIPAA"), the Health Information Technology for Economic and Clinical Health Act ("HITECH"), and the Privacy, Security, Breach Notification, and Enforcement Rules at 45 C.F.R. Parts 160 and 164 (collectively, the "HIPAA Rules").</p>

        <h3>1. DEFINITIONS</h3>
        <p><strong>a.</strong> "Administrative Safeguards" means administrative actions, policies, and procedures to manage the selection, development, implementation, and maintenance of security measures to protect Electronic Protected Health Information ("ePHI") and to manage the conduct of the Business Associate's workforce in relation to the protection of that information, as described in 45 C.F.R. § 164.308.</p>

        <p><strong>b.</strong> "Breach" has the meaning given in 45 C.F.R. § 164.402 and means the acquisition, access, use, or disclosure of Protected Health Information in a manner not permitted by the HIPAA Rules which compromises the security or privacy of the Protected Health Information.</p>

        <p><strong>c.</strong> "Business Associate" has the meaning in 45 C.F.R. § 160.103. For purposes of this Agreement, "Business Associate" means CollagenDirect.</p>

        <p><strong>d.</strong> "Covered Entity" has the meaning in 45 C.F.R. § 160.103. For purposes of this Agreement, "Covered Entity" means the healthcare provider organization, physician, clinic, practice, or facility whose authorized representative registers for or uses the CollagenDirect Provider Portal to transmit or receive PHI.</p>

        <p><strong>e.</strong> "Designated Record Set" has the meaning in 45 C.F.R. § 164.501, and includes medical records, billing records, or other records used to make decisions about an Individual.</p>

        <p><strong>f.</strong> "HIPAA Rules" means the Privacy Rule, Security Rule, Breach Notification Rule, and Enforcement Rule at 45 C.F.R. Parts 160 and 164, as amended.</p>

        <p><strong>g.</strong> "Individual" has the meaning in 45 C.F.R. § 160.103 and includes a Personal Representative consistent with 45 C.F.R. § 164.502(g).</p>

        <p><strong>h.</strong> "Physical Safeguards" means the physical measures, policies, and procedures to protect Business Associate's electronic information systems and related buildings and equipment, from natural and environmental hazards and unauthorized intrusion, as described in 45 C.F.R. § 164.310.</p>

        <p><strong>i.</strong> "Privacy Rule" means the Standards for Privacy of Individually Identifiable Health Information at 45 C.F.R. Part 160 and Subparts A and E of Part 164.</p>

        <p><strong>j.</strong> "Protected Health Information" or "PHI" has the meaning in 45 C.F.R. § 160.103, and includes any individually identifiable health information, in any form or medium, that is created, received, maintained, or transmitted by Business Associate on behalf of Covered Entity.</p>

        <p><strong>k.</strong> "Required by Law" has the meaning in 45 C.F.R. § 164.103.</p>

        <p><strong>l.</strong> "Secretary" means the Secretary of the U.S. Department of Health and Human Services ("HHS") or their designee.</p>

        <p><strong>m.</strong> "Security Incident" has the meaning in 45 C.F.R. § 164.304 and includes any attempted or successful unauthorized access, use, disclosure, modification, or destruction of ePHI, or interference with system operations.</p>

        <p><strong>n.</strong> "Security Rule" means the Security Standards for the Protection of Electronic Protected Health Information at 45 C.F.R. Part 160 and Subparts A and C of Part 164.</p>

        <p><strong>o.</strong> "Technical Safeguards" means the technology and related policies and procedures that protect ePHI and control access to it, as described in 45 C.F.R. § 164.312.</p>

        <p><strong>p.</strong> "Unsecured Protected Health Information" means PHI that is not rendered unusable, unreadable, or indecipherable to unauthorized persons through the use of a technology or methodology specified by the Secretary under 45 C.F.R. § 164.402.</p>

        <p><strong>q.</strong> "Portal" means the CollagenDirect Provider Portal and related services, systems, databases, and workflows provided by Business Associate to Covered Entity for ordering wound care products, tracking status, and transmitting PHI for treatment, payment, and healthcare operations.</p>

        <h3>2. OBLIGATIONS AND ACTIVITIES OF BUSINESS ASSOCIATE</h3>
        <p><strong>a.</strong> Business Associate will not use or disclose PHI other than as permitted by this Agreement or as Required by Law.</p>

        <p><strong>b.</strong> Business Associate will implement reasonable and appropriate safeguards, and comply with the Security Rule with respect to ePHI, to prevent uses or disclosures of PHI not authorized by this Agreement.</p>

        <p><strong>c.</strong> Business Associate will mitigate, to the extent practicable and in good faith cooperation with Covered Entity, any harmful effect of a known use or disclosure of PHI by Business Associate in violation of this Agreement.</p>

        <p><strong>d.</strong> Business Associate will report to Covered Entity, without unreasonable delay and in no event later than ten (10) business days after discovery, any use or disclosure of PHI not provided for in this Agreement, including any Breach of Unsecured PHI as required by 45 C.F.R. § 164.410, and any Security Incident of which it becomes aware. The Parties acknowledge that Covered Entity is hereby deemed notified of routine and unsuccessful attempts to access systems that do not result in unauthorized access, use, or disclosure of PHI.</p>

        <p><strong>e.</strong> Business Associate will ensure that any subcontractor or agent that creates, receives, maintains, or transmits PHI on behalf of Business Associate agrees in writing to the same restrictions, conditions, and obligations that apply to Business Associate with respect to such PHI.</p>

        <p><strong>f.</strong> Business Associate will make available its internal practices, books, and records relating to the use and disclosure of PHI received from, or created or received by Business Associate on behalf of, Covered Entity to the Secretary as required under the HIPAA Rules.</p>

        <p><strong>g.</strong> Business Associate will document disclosures of PHI and related information as necessary for Covered Entity to respond to an Individual's request for an accounting of disclosures under 45 C.F.R. § 164.528, and will provide that information to Covered Entity upon request.</p>

        <p><strong>h.</strong> Business Associate will make PHI in a Designated Record Set available to Covered Entity as necessary to satisfy Covered Entity's obligations under 45 C.F.R. § 164.524 (access of individuals to PHI).</p>

        <p><strong>i.</strong> Business Associate will make amendments to PHI in a Designated Record Set as directed or agreed to by Covered Entity under 45 C.F.R. § 164.526.</p>

        <p><strong>j.</strong> Business Associate may provide data aggregation services relating to the Covered Entity's healthcare operations, as that term is defined in 45 C.F.R. § 164.501.</p>

        <p><strong>k.</strong> To the extent Business Associate carries out one or more Covered Entity obligations under the HIPAA Rules, Business Associate will comply with the requirements of the HIPAA Rules that apply to Covered Entity in the performance of such obligations.</p>

        <h3>3. HIPAA SECURITY RULE REQUIREMENTS</h3>
        <p>Business Associate will:</p>
        <p><strong>a.</strong> Implement, maintain, and document Administrative, Physical, and Technical Safeguards that reasonably and appropriately protect the confidentiality, integrity, and availability of ePHI, including ensuring confidentiality, integrity, availability; protecting against threats; protecting against unauthorized uses/disclosures; and ensuring workforce compliance.</p>

        <p><strong>b.</strong> Ensure that any subcontractor or agent to whom it provides ePHI agrees to implement reasonable and appropriate safeguards consistent with this Section.</p>

        <p><strong>c.</strong> Cooperate in good faith with Covered Entity to mitigate potential or actual harm arising from any Breach or Security Incident caused by Business Associate or its subcontractors.</p>

        <p><strong>d.</strong> Make its policies, procedures, and required documentation relating to these safeguards available to Covered Entity and to the Secretary for purposes of determining Business Associate's compliance with the Security Rule.</p>

        <h3>4. HITECH REQUIREMENTS</h3>
        <p><strong>a.</strong> Business Associate will not directly or indirectly sell PHI or use or disclose PHI for marketing or fundraising in violation of the HIPAA Rules.</p>

        <p><strong>b.</strong> Business Associate will track disclosures of PHI to the extent required for Covered Entity to meet its accounting obligations under the HIPAA Rules and HITECH.</p>

        <p><strong>c.</strong> Business Associate will limit its uses, disclosures, and requests of PHI to the "minimum necessary," consistent with 45 C.F.R. § 164.502(b) and applicable HHS guidance.</p>

        <p><strong>d.</strong> If Business Associate has knowledge of a pattern of activity or practice that constitutes a material breach of this Agreement, and termination of the underlying services is not feasible, Business Associate will report such breach to Covered Entity and, if required, to the Secretary.</p>

        <p><strong>e.</strong> To the extent Business Associate is deemed an agent of Covered Entity under HITECH, Business Associate acknowledges it may be directly subject to civil and criminal penalties under 42 U.S.C. § 1320d–5 and § 1320d–6, as amended.</p>

        <p><strong>f.</strong> Nothing in this Agreement creates an agency relationship between the Parties for any other purpose.</p>

        <h3>5. PERMITTED USES AND DISCLOSURES BY BUSINESS ASSOCIATE</h3>
        <p>Except as otherwise limited in this Agreement, Business Associate may use and disclose PHI:</p>
        <ul>
          <li>To perform services for Covered Entity and operate the Portal (including order intake, fulfillment communication, and status tracking);</li>
          <li>For Business Associate's proper management and administration, or to carry out its legal responsibilities, provided that any disclosure is Required by Law or made to a recipient who has provided written assurances of confidential handling and notification of any improper use or disclosure; and</li>
          <li>For data aggregation and related analytics on behalf of Covered Entity's healthcare operations, as permitted by 45 C.F.R. § 164.504(e)(2)(i)(B).</li>
        </ul>
        <p>Business Associate will not use or disclose PHI in a manner that would violate the HIPAA Rules if done by Covered Entity.</p>

        <h3>6. OBLIGATIONS OF COVERED ENTITY</h3>
        <p>Covered Entity will:</p>
        <p><strong>a.</strong> Provide Business Associate with its Notice of Privacy Practices under 45 C.F.R. § 164.520 and any updates that materially affect Business Associate's permitted uses or disclosures of PHI.</p>

        <p><strong>b.</strong> Inform Business Associate of any changes in, or revocation of, permission by an Individual to use or disclose PHI, if such changes affect Business Associate's permitted uses or disclosures.</p>

        <p><strong>c.</strong> Notify Business Associate of any restriction on the use or disclosure of PHI that Covered Entity has agreed to under 45 C.F.R. § 164.522, if such restriction affects Business Associate's permitted uses or disclosures.</p>

        <p><strong>d.</strong> Obtain any consents, authorizations, or other permissions required by HIPAA, HITECH, the HIPAA Rules, or applicable state law before disclosing PHI to Business Associate.</p>

        <h3>7. TERM AND TERMINATION</h3>
        <p><strong>a. Term.</strong> This Agreement begins on the Effective Date and remains in effect until all PHI provided by Covered Entity to Business Associate, or created or received by Business Associate on behalf of Covered Entity, is returned to Covered Entity or destroyed, or is otherwise protected as described in Section 7(c).</p>

        <p><strong>b. Termination for Cause.</strong> If Covered Entity becomes aware of a material breach of this Agreement by Business Associate, Covered Entity may provide written notice and an opportunity to cure. If Business Associate does not cure within the cure period specified by Covered Entity (not less than thirty (30) days), Covered Entity may terminate this Agreement.</p>

        <p><strong>c. Effect of Termination.</strong> Upon termination, Business Associate will return or destroy all PHI it maintains in any form on behalf of Covered Entity, including PHI held by subcontractors. If return or destruction is infeasible, Business Associate will notify Covered Entity and continue to protect the PHI in accordance with this Agreement.</p>

        <h3>8. MISCELLANEOUS</h3>
        <p><strong>a. Regulatory References.</strong> A reference in this Agreement to a section of the HIPAA Rules means the section as in effect, amended, and required for compliance.</p>

        <p><strong>b. Amendment.</strong> The Parties agree to take such action as is necessary to amend this Agreement from time to time to comply with HIPAA, the HIPAA Rules, HITECH, and other applicable law. CollagenDirect may update this Agreement prospectively. Covered Entity's continued use of the Portal after notice of a material update constitutes acceptance of the updated Agreement.</p>

        <p><strong>c. Survival.</strong> The obligations of Business Associate with respect to PHI that cannot feasibly be returned or destroyed under Section 7(c) shall survive termination of this Agreement for so long as Business Associate retains such PHI.</p>

        <p><strong>d. Interpretation.</strong> Any ambiguity in this Agreement shall be resolved to permit compliance with HIPAA, HITECH, and the HIPAA Rules.</p>

        <p><strong>e. Precedence.</strong> If any provision in another written or electronic service agreement between the Parties conflicts with this Agreement, this Agreement controls with respect to PHI, HIPAA, HITECH, and related privacy/security matters.</p>

        <p><strong>f. Ownership of PHI.</strong> All PHI that Business Associate, or any subcontractor or agent of Business Associate, creates, receives, maintains, or transmits on behalf of Covered Entity remains the property of Covered Entity.</p>

        <p><strong>g. Notice.</strong> Formal legal notices under this Agreement must be in writing and will be deemed delivered when actually received via hand delivery or overnight courier with confirmation, or three (3) business days after being sent via certified U.S. mail. Operational notices may be provided electronically.</p>

        <p><strong>h. Severability.</strong> If any provision of this Agreement is held invalid or unenforceable, that provision shall be severed and the remaining provisions shall remain in full force if consistent with the Parties' intent and applicable law.</p>

        <p><strong>i. Assignment.</strong> Neither Party may assign this Agreement without the other Party's prior written consent, except a Party may assign this Agreement without consent to a successor in interest to substantially all of its relevant business or assets.</p>

        <p><strong>j. Successors and Assigns.</strong> This Agreement is binding upon and inures to the benefit of the Parties and their permitted successors and assigns.</p>

        <p><strong>k. Waiver.</strong> A waiver of any breach is not a waiver of any other breach.</p>

        <p><strong>l. Governing Law / Venue.</strong> This Agreement is governed by the laws of the State of Texas, without regard to conflicts of laws rules. The Parties agree to the exclusive jurisdiction and venue of state or federal courts located in Bexar County, Texas.</p>

        <p><strong>m. HIPAA Compliance.</strong> Each Party will comply with HIPAA, HITECH, and the HIPAA Rules, as amended.</p>

        <p><strong>n. Use of Covered Entity Name/Logo.</strong> Business Associate will not publicly use Covered Entity's name, trade name, service mark, or logo without prior written consent, except as required for fulfillment, regulatory, audit, payer communications, or other Required by Law use.</p>

        <h3>Electronic Execution</h3>
        <p>Covered Entity agrees that:</p>
        <ul>
          <li>Clicking "I Agree" (or similar) during Provider Portal registration, and submitting PHI or patient orders through the Portal, constitutes that organization's binding electronic signature to this Agreement under applicable electronic signature laws;</li>
          <li>CollagenDirect will capture and store (a) the name and title of the registering individual, (b) the Covered Entity/practice name provided at registration, (c) the date/time of acceptance, (d) the IP address and browser metadata at acceptance, and (e) the then-current version identifier of this Agreement; and</li>
          <li>That captured record is sufficient to demonstrate execution of this Agreement between Covered Entity and Business Associate as of the Effective Date.</li>
        </ul>

        <p style="text-align:center;margin-top:2rem;"><strong>END OF AGREEMENT</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-close="baa">Close</button>
      </div>
    </div>
  </div>

  <!-- MSAA Modal -->
  <div id="msaaModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>MD DME Product and Services Agreement</h2>
        <button type="button" class="modal-close" data-close="msaa">&times;</button>
      </div>
      <div class="modal-body">
        <p style="text-align:center;margin-bottom:1.5rem"><strong>COLLAGENDIRECT / MD DME PRODUCT AND SERVICES AGREEMENT</strong><br>Version 2025-10-29</p>

        <p>This Product and Services Agreement ("Agreement") is entered into by and between (1) MD DME, LLC ("MD DME"), a Texas limited liability company, and (2) the physician practice, clinic, or provider organization whose authorized representative is accepting this Agreement ("Client").</p>

        <p><strong>Effective Date.</strong> This Agreement becomes effective on the date the Client (or its authorized representative) registers or is provisioned within the CollagenDirect Provider Portal and affirmatively accepts this Agreement.</p>

        <h3>1. Relationship Between MD DME, Client, and CollagenDirect</h3>
        <p>CollagenDirect provides a secure ordering portal and workflow tools. CollagenDirect does not manufacture, dispense, fulfill, ship, bill, or collect payment for wound care products or Durable Medical Equipment ("Products"), and is not the supplier of record.</p>

        <p>MD DME is a licensed Durable Medical Equipment supplier. MD DME is solely responsible for fulfillment, shipment, documentation, and (when applicable) billing and collection for Products.</p>

        <p>Client acknowledges that:</p>
        <ul>
          <li>Any PHI transmitted through the portal is handled under the HIPAA Business Associate Agreement between Client and CollagenDirect.</li>
          <li>All reimbursement, payer billing, invoicing, collections, and credit terms for Products are strictly between Client and MD DME.</li>
          <li>CollagenDirect has no financial responsibility to Client or to any payer, and CollagenDirect does not assume or guarantee any reimbursement.</li>
        </ul>

        <h3>2. Product and Services Models</h3>
        <p><strong>a. Option A – Physician-Billed Orders.</strong><br>
        MD DME supplies Products listed in Exhibit A. MD DME (as logistics/fulfillment partner) may pick, pack, ship, and deliver Products directly to Client's patients on Client's behalf and provide proof of delivery. Client bills payors through Client's own DME entity and insurance contracts.</p>

        <p>Client remains solely responsible for: medical necessity; correct coding; claim submission; and all payer interactions, adjustments, recoupments, or repayments. MD DME is not responsible for the accuracy or sufficiency of codes or medical necessity determinations under Option A.</p>

        <p><strong>b. Option B – MD DME-Billed Orders.</strong><br>
        Client may direct MD DME to fulfill and ship Products directly to the patient and to bill payors under MD DME's own supplier credentials. In this model, Client must provide MD DME with medical records and a valid Standard Written Order establishing medical necessity.</p>

        <h3>3. Client Responsibilities</h3>
        <ul>
          <li>Client is solely responsible for ensuring clinical appropriateness and medical necessity of all ordered Products.</li>
          <li>Client is solely responsible for accuracy and completeness of coding and claim data when billing under its own contracts.</li>
          <li>Client will maintain all source documents, medical records, and audit trails, and will provide MD DME any supporting information needed to fulfill and ship Products.</li>
          <li>Client will maintain a complete and accurate log of all wound care / DME Products provided to its patients.</li>
        </ul>

        <h3>4. MD DME Responsibilities</h3>
        <p>MD DME will:</p>
        <ul>
          <li>Provide Product specifications, literature, and training support;</li>
          <li>Receive and review orders for completeness;</li>
          <li>Pick, pack, and ship Products in a compliant manner;</li>
          <li>Ship in a timely fashion (normally within 24 hours, excluding weekends);</li>
          <li>Ship via a method with tracking;</li>
          <li>Provide tracking details, proof of delivery, and (where applicable) patient invoice copies.</li>
        </ul>

        <p>After MD DME supplies proof of delivery, MD DME is not responsible for Client's ongoing record-keeping, audit defense, or payor documentation obligations, including obligations under 42 C.F.R. § 424.57(c)(12).</p>

        <h3>5. Financial Terms / Responsibility</h3>
        <p>For Option A (physician-billed orders), Client shall pay MD DME's invoices in full on the following cycle:</p>
        <ul>
          <li>Shipments from the 1st–15th → payment due the 15th of the following month.</li>
          <li>Shipments from the 16th–end of month → payment due the 1st of the following month.</li>
        </ul>

        <p style="margin-left:2rem">
          <strong>a.</strong> Late invoices accrue service charges at 2% APR.<br>
          <strong>b.</strong> MD DME may suspend fulfillment for invoices more than 30 days past due, and may resume only after full payment is received.<br>
          <strong>c.</strong> Client (and any personal guarantor, if applicable) is jointly and severally liable for all unpaid amounts, including reasonable collection costs and attorney's fees. CollagenDirect is not liable for any such amounts.
        </p>

        <h3>6. Compliance</h3>
        <p>Each Party will comply with all applicable federal and state laws and billing rules, including Medicare/Medicaid requirements regarding claims, coding, fraud, waste, and abuse.</p>

        <h3>7. Term and Renewal</h3>
        <p>The initial term is one (1) year from the Effective Date, automatically renewing for additional one (1) year terms unless either Party provides 30 days' written notice of non-renewal.</p>

        <h3>8. Non-Exclusivity</h3>
        <p>Client is not obligated to purchase exclusively from MD DME.</p>

        <h3>9. Termination</h3>
        <p>Either Party may terminate immediately if:</p>
        <ul>
          <li>A required professional or supplier license is suspended, revoked, or restricted;</li>
          <li>A Party files for bankruptcy or seeks creditor protection;</li>
          <li>A Party reasonably believes that continuing the relationship would violate applicable state or federal law, regulation, or guidance; or</li>
          <li>Upon 30 days' written notice.</li>
        </ul>

        <p>Upon termination, MD DME may complete orders already in process and must be paid for those orders consistent with Section 5.</p>

        <h3>10. Confidentiality</h3>
        <p>Business information exchanged under this Agreement is confidential. Neither Party will disclose the terms of this Agreement to third parties except as required by law, payer audit, accreditation, lender/underwriter review, or legal counsel.</p>

        <h3>11. HIPAA</h3>
        <p>To the extent MD DME acts as a Business Associate, HIPAA obligations are governed by the applicable Business Associate Agreement, which is incorporated by reference.</p>

        <h3>12. Limitation of Liability / Indemnification</h3>
        <p>Except for gross negligence or willful misconduct, MD DME's total liability to Client shall not exceed the total amounts actually paid by Client to MD DME during the then-current term.</p>

        <p>Neither MD DME nor CollagenDirect will be liable for any indirect, special, incidental, consequential, punitive, or lost-profit damages.</p>

        <p>Client agrees to indemnify and hold harmless MD DME and CollagenDirect (and their owners, officers, directors, and employees) from claims, penalties, costs, or liabilities arising out of (a) Client's clinical decisions or medical necessity determinations, (b) Client's billing and coding activities, or (c) Client's breach of this Agreement.</p>

        <h3>13. Governing Law</h3>
        <p>Texas law governs this Agreement.</p>

        <h3>14. Force Majeure</h3>
        <p>Neither Party is liable for delays or failures caused by events beyond reasonable control, including natural disasters, infrastructure outages, or acts of terrorism.</p>

        <h3>15. Assignment</h3>
        <p>Neither Party may assign this Agreement without written consent, except to a successor acquiring substantially all relevant assets or operations.</p>

        <h3>16. Entire Agreement / Amendment</h3>
        <p>This Agreement is the complete and exclusive statement of the Parties' understanding regarding product fulfillment, billing responsibility, and payment terms. It may be amended only in a writing (including an electronic update notice accepted within the Portal) agreed to by both Parties.</p>

        <h3>17. Electronic Execution.</h3>
        <p>By submitting registration through the CollagenDirect Provider Portal and checking the acceptance box, the signer certifies they are an authorized representative of the Client and agree on behalf of the Client to be bound by this Agreement.</p>

        <p>CollagenDirect will capture and store: (i) the signer's name, (ii) practice name, (iii) the date/time of acceptance, (iv) the IP address and browser metadata at acceptance, and (v) the version of this Agreement. That captured record is deemed the Parties' binding electronic signature.</p>

        <p style="text-align:center;margin-top:2rem"><strong>END OF AGREEMENT</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-close="msaa">Close</button>
      </div>
    </div>
  </div>

  <script src="/portal/search-helpers.js"></script>
  <script>
  (function () {
    // Modal handlers (BAA and MSAA)
    document.addEventListener('click', (e) => {
      // Handle opening modals
      const openBtn = e.target.closest('[data-open]');
      if (openBtn) {
        e.preventDefault();
        const modalId = openBtn.getAttribute('data-open');
        const modal = document.getElementById(modalId + 'Modal');
        if (modal) modal.classList.add('show');
      }

      // Handle closing modals
      const closeBtn = e.target.closest('[data-close]');
      if (closeBtn) {
        const modalId = closeBtn.getAttribute('data-close');
        const modal = document.getElementById(modalId + 'Modal');
        if (modal) modal.classList.remove('show');
      }

      // Handle clicking overlay background
      if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('show');
      }
    });

    // Populate state selects
    const states = ["AL","AK","AZ","AR","CA","CO","CT","DC","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA","WI","WV","WY"];
    for (const id of ["state","licenseState","dmeState"]) {
      const el = document.getElementById(id);
      if (!el) continue;
      el.append(new Option("Select",""));
      states.forEach(s => el.append(new Option(s, s)));
    }

    // Default sign date
    const today = new Date().toISOString().slice(0,10);
    const signDate = document.getElementById('signDate');
    if (signDate) signDate.value = today;

    // Track additional physicians
    let additionalPhysicians = [];
    let physicianCounter = 0;

    // User type selection logic
    const userTypeCards = document.querySelectorAll('.user-type-card');
    const practiceInfoSection = document.getElementById('practiceInfoSection');
    const physicianCredsSection = document.getElementById('physicianCredsSection');
    const additionalPhysiciansSection = document.getElementById('additionalPhysiciansSection');
    const practiceManagerLinkSection = document.getElementById('practiceManagerLinkSection');
    const dmeSection = document.getElementById('dmeSection');
    const agreementsSection = document.getElementById('agreementsSection');

    userTypeCards.forEach(card => {
      card.addEventListener('click', function() {
        // Update visual selection
        userTypeCards.forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');

        // Check the radio button
        const radio = this.querySelector('input[type="radio"]');
        radio.checked = true;

        // Get selected type
        const selectedType = radio.value;

        // Show/hide sections based on user type
        if (selectedType === 'practice_admin') {
          // Practice Manager: Show practice info, physician creds, additional physicians, agreements
          practiceInfoSection.hidden = false;
          physicianCredsSection.hidden = false;
          additionalPhysiciansSection.hidden = false;
          practiceManagerLinkSection.hidden = true;
          dmeSection.hidden = true;
          agreementsSection.hidden = false;

          // Initialize address autocomplete now that section is visible
          if (typeof initAddressAutocomplete === 'function' && document.getElementById('address')) {
            initAddressAutocomplete('address', (addressData) => {
              // Use formatted address as the main address field
              document.getElementById('address').value = addressData.formatted || addressData.street || '';
              // Store parsed components in hidden fields for database
              document.getElementById('city').value = addressData.city || '';
              document.getElementById('state').value = addressData.state || '';
              document.getElementById('zip').value = addressData.zip || '';
            });
          }

          // Set required fields
          setRequired(['practiceName', 'address', 'city', 'state', 'zip', 'phone', 'firstName', 'lastName', 'npi', 'license', 'licenseState', 'licenseExpiry', 'agreeMSA', 'agreeBAA', 'signName', 'signTitle', 'signDate']);
          setOptional(['dmeNumber', 'dmeState', 'dmeExpiry', 'practiceManagerEmail']);

        } else if (selectedType === 'physician') {
          // Physician: Show physician creds, practice manager link, agreements only
          practiceInfoSection.hidden = true;
          physicianCredsSection.hidden = false;
          additionalPhysiciansSection.hidden = true;
          practiceManagerLinkSection.hidden = false;
          dmeSection.hidden = true;
          agreementsSection.hidden = false;

          // Set required fields
          setRequired(['firstName', 'lastName', 'npi', 'license', 'licenseState', 'licenseExpiry', 'practiceManagerEmail', 'agreeMSA', 'agreeBAA', 'signName', 'signTitle', 'signDate']);
          setOptional(['practiceName', 'address', 'city', 'state', 'zip', 'phone', 'dmeNumber', 'dmeState', 'dmeExpiry']);

        } else if (selectedType === 'dme_hybrid' || selectedType === 'dme_wholesale') {
          // DME Users: Show practice info, physician creds, DME info, agreements
          practiceInfoSection.hidden = false;
          physicianCredsSection.hidden = false;
          additionalPhysiciansSection.hidden = true;
          practiceManagerLinkSection.hidden = true;
          dmeSection.hidden = false;
          agreementsSection.hidden = false;

          // Initialize address autocomplete now that section is visible
          if (typeof initAddressAutocomplete === 'function' && document.getElementById('address')) {
            initAddressAutocomplete('address', (addressData) => {
              // Use formatted address as the main address field
              document.getElementById('address').value = addressData.formatted || addressData.street || '';
              // Store parsed components in hidden fields for database
              document.getElementById('city').value = addressData.city || '';
              document.getElementById('state').value = addressData.state || '';
              document.getElementById('zip').value = addressData.zip || '';
            });
          }

          // Set required fields
          setRequired(['practiceName', 'address', 'city', 'state', 'zip', 'phone', 'firstName', 'lastName', 'npi', 'license', 'licenseState', 'licenseExpiry', 'dmeNumber', 'dmeState', 'dmeExpiry', 'agreeMSA', 'agreeBAA', 'signName', 'signTitle', 'signDate']);
          setOptional(['practiceManagerEmail']);
        }
      });
    });

    function setRequired(fields) {
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.required = true;
      });
    }

    function setOptional(fields) {
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.required = false;
      });
    }

    // Add physician functionality
    const btnAddPhysician = document.getElementById('btnAddPhysician');
    const additionalPhysiciansList = document.getElementById('additionalPhysiciansList');

    btnAddPhysician?.addEventListener('click', () => {
      physicianCounter++;
      const physicianId = `physician_${physicianCounter}`;

      const physicianItem = document.createElement('div');
      physicianItem.className = 'physician-item';
      physicianItem.id = physicianId;
      physicianItem.innerHTML = `
        <div class="physician-item-header">
          <h4>Physician ${physicianCounter}</h4>
          <button type="button" class="btn-remove" data-physician-id="${physicianId}">Remove</button>
        </div>
        <div class="form-grid">
          <div>
            <label>First Name</label>
            <input type="text" data-field="firstName" data-physician-id="${physicianId}" required />
          </div>
          <div>
            <label>Last Name</label>
            <input type="text" data-field="lastName" data-physician-id="${physicianId}" required />
          </div>
          <div>
            <label>NPI Number</label>
            <input type="text" data-field="npi" data-physician-id="${physicianId}" pattern="\\d{10}" placeholder="10 digits" required />
          </div>
          <div>
            <label>Medical License #</label>
            <input type="text" data-field="license" data-physician-id="${physicianId}" required />
          </div>
          <div>
            <label>License State</label>
            <select data-field="licenseState" data-physician-id="${physicianId}" required>
              <option value="">Select</option>
              ${states.map(s => `<option value="${s}">${s}</option>`).join('')}
            </select>
          </div>
          <div>
            <label>License Expiry</label>
            <input type="date" data-field="licenseExpiry" data-physician-id="${physicianId}" required />
          </div>
          <div>
            <label>Email (optional)</label>
            <input type="email" data-field="email" data-physician-id="${physicianId}" placeholder="physician@practice.com" />
          </div>
          <div>
            <label>Phone (optional)</label>
            <input type="tel" data-field="phone" data-physician-id="${physicianId}" placeholder="(555) 555-5555" />
          </div>
        </div>
      `;

      additionalPhysiciansList.appendChild(physicianItem);

      // Add remove handler
      physicianItem.querySelector('.btn-remove').addEventListener('click', function() {
        const id = this.dataset.physicianId;
        document.getElementById(id)?.remove();
        additionalPhysicians = additionalPhysicians.filter(p => p.id !== id);
      });
    });

    // Collect additional physicians data
    function collectAdditionalPhysicians() {
      const physicians = [];
      const items = additionalPhysiciansList.querySelectorAll('.physician-item');

      items.forEach(item => {
        const physicianId = item.id;
        const inputs = item.querySelectorAll(`[data-physician-id="${physicianId}"]`);
        const physician = {};

        inputs.forEach(input => {
          const field = input.dataset.field;
          physician[field] = input.value.trim();
        });

        if (physician.firstName && physician.lastName && physician.npi) {
          physicians.push(physician);
        }
      });

      return physicians;
    }

    // NPI validation
    function isValidNPI(npi){
      if(!/^\d{10}$/.test(npi)) return false;
      const prefix = '80840' + npi.slice(0,9);
      const digits = prefix.split('').map(Number);
      for (let i = digits.length - 1; i >= 0; i -= 2){ digits[i] *= 2; if (digits[i] > 9) digits[i] -= 9; }
      const sum = digits.reduce((a,b)=>a+b,0);
      const check = (10 - (sum % 10)) % 10;
      return check === Number(npi[9]);
    }

    const btnValidate = document.getElementById('btnValidateNPI');
    const npiInput = document.getElementById('npi');
    const npiStatus = document.getElementById('npiStatus');
    btnValidate?.addEventListener('click',()=>{
      const ok = isValidNPI(npiInput.value.trim());
      npiStatus.textContent = ok ? 'NPI format valid (checksum passed)' : 'Invalid NPI number';
      npiStatus.className = 'status ' + (ok ? 'ok' : 'bad');
    });

    // CSRF helper
    async function csrf(){ const r = await fetch('/api/csrf.php',{credentials:'include'}); return (await r.json()).csrfToken; }

    // Validation helper functions
    function clearValidationErrors() {
      document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
      document.getElementById('validationSummary').classList.remove('show');
      document.getElementById('validationList').innerHTML = '';
    }

    function showValidationError(fieldId, message) {
      const field = document.getElementById(fieldId) || document.querySelector(`#${fieldId}`);
      if (field) {
        field.classList.add('field-error');
      }

      const list = document.getElementById('validationList');
      const li = document.createElement('li');
      li.textContent = message;
      list.appendChild(li);
    }

    function validateForm() {
      clearValidationErrors();
      const errors = [];
      const selectedType = document.querySelector('input[name="userType"]:checked');

      // 1. Check user type selection
      if (!selectedType) {
        errors.push({ field: null, message: 'Please select an account type' });
      }

      // 2. Validate email
      const email = document.getElementById('email');
      if (!email.value.trim()) {
        errors.push({ field: 'field-email', message: 'Email is required' });
      } else if (!email.value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        errors.push({ field: 'field-email', message: 'Please enter a valid email address' });
      }

      // 3. Validate password
      const password = document.getElementById('password');
      if (!password.value) {
        errors.push({ field: 'field-password', message: 'Password is required' });
      } else if (password.value.length < 8) {
        errors.push({ field: 'field-password', message: 'Password must be at least 8 characters' });
      }

      if (!selectedType) {
        // Show errors and stop if no type selected
        if (errors.length > 0) {
          errors.forEach(err => {
            if (err.field) showValidationError(err.field, err.message);
            else {
              const list = document.getElementById('validationList');
              const li = document.createElement('li');
              li.textContent = err.message;
              list.appendChild(li);
            }
          });
          document.getElementById('validationSummary').classList.add('show');
          document.getElementById('validationSummary').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        return false;
      }

      const userType = selectedType.value;

      // Type-specific validation
      if (userType === 'practice_admin') {
        // Practice info required
        if (!document.getElementById('practiceName').value.trim()) {
          errors.push({ field: 'field-practiceName', message: 'Practice name is required' });
        }
        if (!document.getElementById('address').value.trim()) {
          errors.push({ field: 'field-address', message: 'Street address is required' });
        }
        if (!document.getElementById('city').value.trim()) {
          errors.push({ field: 'field-city', message: 'City is required' });
        }
        if (!document.getElementById('state').value) {
          errors.push({ field: 'field-state', message: 'State is required' });
        }
        if (!document.getElementById('zip').value.trim()) {
          errors.push({ field: 'field-zip', message: 'ZIP code is required' });
        }
        if (!document.getElementById('phone').value.trim()) {
          errors.push({ field: 'field-phone', message: 'Phone number is required' });
        }
      }

      if (userType === 'physician') {
        // Practice manager email required
        if (!document.getElementById('practiceManagerEmail').value.trim()) {
          errors.push({ field: 'field-practiceManagerEmail', message: 'Practice manager email is required' });
        }
      }

      if (userType === 'dme_hybrid' || userType === 'dme_wholesale') {
        // Practice info + DME license required
        if (!document.getElementById('practiceName').value.trim()) {
          errors.push({ field: 'field-practiceName', message: 'Practice name is required' });
        }
        if (!document.getElementById('address').value.trim()) {
          errors.push({ field: 'field-address', message: 'Street address is required' });
        }
        if (!document.getElementById('city').value.trim()) {
          errors.push({ field: 'field-city', message: 'City is required' });
        }
        if (!document.getElementById('state').value) {
          errors.push({ field: 'field-state', message: 'State is required' });
        }
        if (!document.getElementById('zip').value.trim()) {
          errors.push({ field: 'field-zip', message: 'ZIP code is required' });
        }
        if (!document.getElementById('phone').value.trim()) {
          errors.push({ field: 'field-phone', message: 'Phone number is required' });
        }
        if (!document.getElementById('dmeNumber').value.trim()) {
          errors.push({ field: 'field-dmeNumber', message: 'DME license number is required' });
        }
        if (!document.getElementById('dmeState').value) {
          errors.push({ field: 'field-dmeState', message: 'DME state is required' });
        }
        if (!document.getElementById('dmeExpiry').value) {
          errors.push({ field: 'field-dmeExpiry', message: 'DME expiry date is required' });
        }
      }

      // Physician credentials (required for all types)
      if (!document.getElementById('firstName').value.trim()) {
        errors.push({ field: 'field-firstName', message: 'First name is required' });
      }
      if (!document.getElementById('lastName').value.trim()) {
        errors.push({ field: 'field-lastName', message: 'Last name is required' });
      }
      if (!document.getElementById('npi').value.trim()) {
        errors.push({ field: 'field-npi', message: 'NPI number is required' });
      } else if (!isValidNPI(document.getElementById('npi').value.trim())) {
        errors.push({ field: 'field-npi', message: 'Please enter a valid NPI number (click Validate NPI)' });
      }
      if (!document.getElementById('license').value.trim()) {
        errors.push({ field: 'field-license', message: 'Medical license number is required' });
      }
      if (!document.getElementById('licenseState').value) {
        errors.push({ field: 'field-licenseState', message: 'License state is required' });
      }
      if (!document.getElementById('licenseExpiry').value) {
        errors.push({ field: 'field-licenseExpiry', message: 'License expiry date is required' });
      }

      // Agreements
      if (!document.getElementById('agreeMSA').checked) {
        errors.push({ field: 'field-agreeMSA', message: 'You must agree to the Master Services Agreement' });
      }
      if (!document.getElementById('agreeBAA').checked) {
        errors.push({ field: 'field-agreeBAA', message: 'You must agree to the Business Associate Agreement' });
      }
      if (!document.getElementById('signName').value.trim()) {
        errors.push({ field: 'field-signName', message: 'Signature name is required' });
      }
      if (!document.getElementById('signTitle').value.trim()) {
        errors.push({ field: 'field-signTitle', message: 'Signature title is required' });
      }
      if (!document.getElementById('signDate').value) {
        errors.push({ field: 'field-signDate', message: 'Signature date is required' });
      }

      // Display errors if any
      if (errors.length > 0) {
        errors.forEach(err => {
          if (err.field) showValidationError(err.field, err.message);
          else {
            const list = document.getElementById('validationList');
            const li = document.createElement('li');
            li.textContent = err.message;
            list.appendChild(li);
          }
        });
        document.getElementById('validationSummary').classList.add('show');
        document.getElementById('validationSummary').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        return false;
      }

      return true;
    }

    // Submit handler
    const form = document.getElementById('registerForm');
    const submitBtn = document.getElementById('submitBtn');

    submitBtn?.addEventListener('click', async () => {
      // Run comprehensive validation
      if (!validateForm()) {
        return;
      }

      const selectedType = document.querySelector('input[name="userType"]:checked');

      const payload = {
        userType: selectedType.value,
        email: document.getElementById('email').value.trim(),
        password: document.getElementById('password').value,
        firstName: document.getElementById('firstName')?.value.trim() || null,
        lastName: document.getElementById('lastName')?.value.trim() || null,
        npi: document.getElementById('npi')?.value.trim() || null,
        license: document.getElementById('license')?.value.trim() || null,
        licenseState: document.getElementById('licenseState')?.value || null,
        licenseExpiry: document.getElementById('licenseExpiry')?.value || null,
        practiceName: document.getElementById('practiceName')?.value.trim() || null,
        taxId: document.getElementById('taxId')?.value.trim() || null,
        address: document.getElementById('address')?.value.trim() || null,
        city: document.getElementById('city')?.value.trim() || null,
        state: document.getElementById('state')?.value || null,
        zip: document.getElementById('zip')?.value.trim() || null,
        phone: document.getElementById('phone')?.value.trim() || null,
        dmeNumber: document.getElementById('dmeNumber')?.value.trim() || null,
        dmeState: document.getElementById('dmeState')?.value || null,
        dmeExpiry: document.getElementById('dmeExpiry')?.value || null,
        practiceManagerEmail: document.getElementById('practiceManagerEmail')?.value.trim() || null,
        additionalPhysicians: selectedType.value === 'practice_admin' ? collectAdditionalPhysicians() : [],
        agreeMSA: document.getElementById('agreeMSA').checked,
        agreeBAA: document.getElementById('agreeBAA').checked,
        signName: document.getElementById('signName').value.trim(),
        signTitle: document.getElementById('signTitle').value.trim(),
        signDate: document.getElementById('signDate').value
      };

      try {
        const token = await csrf();
        const res = await fetch('/api/register.php', {
          method:'POST',
          headers:{'Content-Type':'application/json','x-csrf-token':token},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        if (res.status === 201 || data.ok) {
          alert('Registration submitted successfully!');
          location.href = '/portal';
        } else {
          alert('Registration error: ' + (data.error || JSON.stringify(data)));
        }
      } catch (err) {
        alert('Network error. Please try again.');
        console.error(err);
      }
    });

    // Set year in footer
    document.getElementById('year').textContent = new Date().getFullYear();
  })();
  </script>
</body>
</html>
