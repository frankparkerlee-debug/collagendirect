<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Register — Physician Portal | CollagenDirect</title>
  <meta name="description" content="Create a secure CollagenDirect physician account to access ordering, documentation, and patient workflows." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#fafafa; --text:#1e2a38; --muted:#6b7280; --line:#e5e7eb;
      --brand:#5FA8A1; --brand-hover:#4d8d87;
      --radius:12px; --shadow:0 1px 3px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    img{max-width:100%;display:block}
    a{text-decoration:none;color:inherit}
    .container{max-width:1200px;margin:0 auto;padding:0 1.5rem}

    /* Simple header */
    header{
      background:#fff;
      border-bottom:1px solid var(--line);
      padding:1rem 0;
    }
    .nav{
      max-width:1200px;
      margin:0 auto;
      padding:0 1.5rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:32px;width:auto}
    .brand .title{font-weight:700;font-size:1rem;letter-spacing:.3px}

    /* Main content area */
    main{
      flex:1;
      padding:3rem 0;
    }
    .auth-card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:2.5rem;
      box-shadow:0 4px 6px -1px rgba(0,0,0,.05),0 2px 4px -1px rgba(0,0,0,.03);
      max-width:900px;
      margin:0 auto;
    }
    .auth-card h2{
      font-size:1.75rem;
      font-weight:700;
      color:#111;
      margin-bottom:0.5rem;
    }
    .muted{color:var(--muted)}
    .section-title{
      font-size:1.125rem;
      font-weight:600;
      color:#374151;
      margin-top:2rem;
      margin-bottom:1rem;
      padding-bottom:0.5rem;
      border-bottom:1px solid var(--line);
    }

    /* Form styling */
    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:1rem;
      margin-top:1rem;
    }
    .form-grid > div{
      display:flex;
      flex-direction:column;
      gap:0.5rem;
    }

    /* Inputs */
    .auth-card input,.auth-card select,.auth-card textarea{
      width:100%;
      padding:0.75rem 1rem;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      outline:none;
      font-size:0.95rem;
      transition:border-color 0.2s,box-shadow 0.2s;
    }
    .auth-card input::placeholder{color:#9ca3af}
    .auth-card input:focus,.auth-card select:focus,.auth-card textarea:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(95,168,161,.1);
    }
    label{
      display:block;
      font-weight:500;
      font-size:0.875rem;
      color:#374151;
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:0.875rem;
    }
    .row a{
      color:var(--brand);
      text-decoration:none;
      font-weight:500;
    }
    .row a:hover{text-decoration:underline}

    /* Buttons */
    .btn{
      padding:0.75rem 1.5rem;
      border-radius:var(--radius);
      font-weight:600;
      font-size:0.95rem;
      cursor:pointer;
      border:1px solid var(--line);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s;
      background:#fff;
      color:#374151;
    }
    .btn:hover{
      background:#f9fafb;
    }
    .btn.primary{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    .btn.primary:hover{
      background:var(--brand-hover);
    }
    .btn.ghost{
      background:#fff;
      border:1px solid var(--line);
      color:#374151;
    }
    .btn.ghost:hover{
      background:#f9fafb;
    }

    /* Messages */
    .error{
      display:none;
      margin:0 0 1rem;
      padding:0.75rem 1rem;
      border-radius:var(--radius);
      border:1px solid #fecaca;
      background:#fef2f2;
      color:#991b1b;
      font-size:0.875rem;
    }
    .success{
      display:none;
      margin:0 0 1rem;
      padding:0.75rem 1rem;
      border-radius:var(--radius);
      border:1px solid #d1fae5;
      background:#ecfdf5;
      color:#065f46;
      font-size:0.875rem;
    }

    /* Status indicators */
    .status{
      padding:0.5rem 0.75rem;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:#fff;
      font-size:0.875rem;
    }
    .status.ok{
      border-color:#d1fae5;
      background:#ecfdf5;
      color:#065f46;
    }
    .status.bad{
      border-color:#fecaca;
      background:#fef2f2;
      color:#991b1b;
    }

    /* Fieldset styling */
    fieldset{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:1.5rem;
      margin-top:1rem;
    }
    legend{
      padding:0 0.5rem;
      font-weight:600;
      color:#374151;
    }

    /* Footer */
    footer{
      background:#fff;
      border-top:1px solid var(--line);
      padding:1rem;
      text-align:center;
      color:var(--muted);
      font-size:0.875rem;
    }

    /* Responsive */
    @media (max-width:640px){
      .form-grid{grid-template-columns:1fr}
      .auth-card{padding:1.5rem}
      .auth-card h2{font-size:1.5rem}
    }
  </style>
</head>
<body>
  <!-- Simple header -->
  <header>
    <div class="nav">
      <a href="/index.html" class="brand" aria-label="Go to homepage">
        <img src="/assets/collagendirect.png" alt="CollagenDirect logo">
        <span class="title">COLLAGEN <span style="color:#5FA8A1">DIRECT</span></span>
      </a>
    </div>
  </header>

  <!-- Main registration form -->
  <main class="container">
    <section class="auth-card">
      <h2>Create Your Physician Account</h2>
      <p class="muted">Already have an account? <a href="/portal" style="color:var(--brand);font-weight:500">Sign in</a></p>

      <!-- === YOUR ORIGINAL FORM & IDs (unchanged) === -->
      <form id="registerForm" novalidate action="javascript:void(0)">
        <section class="card" aria-labelledby="acct-title" style="border:none;box-shadow:none;padding:0">
          <h2 id="acct-title" class="section-title" style="margin:0 0 8px">Account</h2>
          <div class="form-grid">
            <div>
              <label for="email">Work Email</label>
              <input id="email" type="email" required placeholder="name@practice.com" />
              <div class="muted" style="font-size:.9rem">Used for login and agreement copies.</div>
            </div>
            <div>
              <label for="password">Password</label>
              <input id="password" type="password" minlength="8" required placeholder="••••••••" />
              <div class="muted" style="font-size:.9rem">Min 8 chars, include a number.</div>
            </div>
          </div>
        </section>

        <section class="card" aria-labelledby="practice-title" style="border:none;box-shadow:none;padding:0;margin-top:18px">
          <h2 id="practice-title" class="section-title" style="margin:0 0 8px">Practice Information</h2>
          <div class="form-grid">
            <div>
              <label for="practiceName">Practice / Facility Name</label>
              <input id="practiceName" required />
            </div>
            <div>
              <label for="taxId">Tax ID (optional)</label>
              <input id="taxId" placeholder="##-#######" />
            </div>
            <div>
              <label for="address">Street Address</label>
              <input id="address" required />
            </div>
            <div>
              <label for="city">City</label>
              <input id="city" required />
            </div>
            <div>
              <label for="state">State</label>
              <select id="state" required></select>
            </div>
            <div>
              <label for="zip">ZIP</label>
              <input id="zip" pattern="\d{5}(-\d{4})?" required placeholder="12345" />
            </div>
            <div>
              <label for="phone">Practice Phone</label>
              <input id="phone" type="tel" required placeholder="(555) 555-5555" />
            </div>
          </div>
        </section>

        <section class="card" aria-labelledby="cred-title" style="border:none;box-shadow:none;padding:0;margin-top:18px">
          <h2 id="cred-title" class="section-title" style="margin:0 0 8px">Physician Credentials</h2>
          <div class="form-grid">
            <div><label for="firstName">First Name</label><input id="firstName" required /></div>
            <div><label for="lastName">Last Name</label><input id="lastName" required /></div>
            <div><label for="npi">NPI Number</label><input id="npi" inputmode="numeric" pattern="\d{10}" required placeholder="10 digits" /></div>
          </div>
          <div class="form-grid" style="margin-top:12px">
            <div><label for="license">Medical License #</label><input id="license" required /></div>
            <div><label for="licenseState">License State</label><select id="licenseState" required></select></div>
            <div><label for="licenseExpiry">License Expiry</label><input id="licenseExpiry" type="date" required /></div>
          </div>
          <div class="row" style="margin-top:10px;gap:12px">
            <button type="button" class="btn" id="btnValidateNPI">Validate NPI</button>
            <span id="npiStatus" class="status" aria-live="polite" style="padding:.5rem .7rem;border-radius:10px;border:1px solid var(--line);background:#fff">NPI not validated</span>
          </div>
        </section>

        <section class="card" aria-labelledby="type-title" style="border:none;box-shadow:none;padding:0;margin-top:18px">
          <h2 id="type-title" class="section-title" style="margin:0 0 8px">Account Type</h2>
          <fieldset style="border:1px solid var(--line);border-radius:14px;padding:16px">
            <legend style="padding:0 .4rem;font-weight:700">Select one</legend>
            <div class="form-grid">
              <label style="display:flex;gap:.6rem;align-items:flex-start"><input type="radio" name="acctType" value="referral" required /><div><strong>Referral-Only</strong><div class="muted">You refer patients; we bill and ship.</div></div></label>
              <label style="display:flex;gap:.6rem;align-items:flex-start"><input type="radio" name="acctType" value="wholesale" /><div><strong>Wholesale</strong><div class="muted">You hold a DME license and bill directly.</div></div></label>
              <label style="display:flex;gap:.6rem;align-items:flex-start"><input type="radio" name="acctType" value="hybrid" /><div><strong>Hybrid</strong><div class="muted">Some patients billed by you, others by us.</div></div></label>
            </div>
          </fieldset>
          <div id="dmeBlock" hidden style="margin-top:14px">
            <div class="form-grid">
              <div><label for="dmeNumber">DME License #</label><input id="dmeNumber" /></div>
              <div><label for="dmeState">DME State</label><select id="dmeState"></select></div>
              <div><label for="dmeExpiry">DME Expiry</label><input id="dmeExpiry" type="date" /></div>
            </div>
          </div>
        </section>

        <section class="card" aria-labelledby="agreements-title" style="border:none;box-shadow:none;padding:0;margin-top:18px">
          <h2 id="agreements-title" class="section-title" style="margin:0 0 8px">Agreements & e-Sign</h2>
          <div class="form-grid">
            <div>
              <label>Master Services & Supply Agreement</label>
              <div class="row" style="gap:12px">
                <button type="button" class="btn" data-open="msaa">Preview</button>
                <label class="row" style="gap:8px"><input id="agreeMSA" type="checkbox" required /> <span>I agree</span></label>
              </div>
            </div>
            <div>
              <label>Business Associate Agreement (BAA)</label>
              <div class="row" style="gap:12px">
                <button type="button" class="btn" data-open="baa">Preview</button>
                <label class="row" style="gap:8px"><input id="agreeBAA" type="checkbox" required /> <span>I agree</span></label>
              </div>
            </div>
          </div>
          <div class="form-grid" style="margin-top:10px">
            <div><label for="signName">Full Legal Name (Signature)</label><input id="signName" required /></div>
            <div><label for="signTitle">Title</label><input id="signTitle" required placeholder="MD, DO, etc." /></div>
            <div><label for="signDate">Date</label><input id="signDate" type="date" required /></div>
          </div>
        </section>

        <div class="row" style="margin-top:2rem;gap:12px;flex-wrap:wrap">
          <button id="submitBtn" type="button" class="btn primary">Create Account</button>
          <a class="btn ghost" href="/portal">Already registered? Log in</a>
        </div>

        <p class="muted" style="margin-top:1.5rem;text-align:center;font-size:0.875rem">
          For assistance, contact <a href="mailto:clinical@collagendirect.com" style="color:var(--brand);font-weight:500">clinical@collagendirect.com</a>
        </p>
      </form>
      <!-- === /YOUR ORIGINAL FORM === -->
    </section>
  </main>

  <!-- Simple footer -->
  <footer>
    © <span id="year"></span> CollagenDirect. All rights reserved.
  </footer>

  <!-- === YOUR ORIGINAL JS (unchanged) === -->
  <script>
  (function () {
    // Populate state selects
    const states = ["AL","AK","AZ","AR","CA","CO","CT","DC","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA","WI","WV","WY"];
    for (const id of ["state","licenseState","dmeState"]) {
      const el = document.getElementById(id);
      if (!el) continue;
      el.append(new Option("Select",""));
      states.forEach(s => el.append(new Option(s, s)));
    }

    // Default sign date
    const today = new Date().toISOString().slice(0,10);
    const signDate = document.getElementById('signDate');
    if (signDate) signDate.value = today;

    // DME toggle
    const dmeBlock = document.getElementById('dmeBlock');
    document.querySelectorAll('input[name="acctType"]').forEach(r=>{
      r.addEventListener('change',()=>{ dmeBlock.hidden = !(r.value !== 'referral' && r.checked); });
    });

    // NPI validation
    function isValidNPI(npi){
      if(!/^\d{10}$/.test(npi)) return false;
      const prefix = '80840' + npi.slice(0,9);
      const digits = prefix.split('').map(Number);
      for (let i = digits.length - 1; i >= 0; i -= 2){ digits[i] *= 2; if (digits[i] > 9) digits[i] -= 9; }
      const sum = digits.reduce((a,b)=>a+b,0);
      const check = (10 - (sum % 10)) % 10;
      return check === Number(npi[9]);
    }

    const btnValidate = document.getElementById('btnValidateNPI');
    const npiInput = document.getElementById('npi');
    const npiStatus = document.getElementById('npiStatus');
    btnValidate?.addEventListener('click',()=>{
      const ok = isValidNPI(npiInput.value.trim());
      npiStatus.textContent = ok ? 'NPI format valid (checksum passed).' : 'Invalid NPI number';
      npiStatus.className = 'status ' + (ok ? 'ok' : 'bad');
    });

    // CSRF helper
    async function csrf(){ const r = await fetch('/api/csrf.php',{credentials:'include'}); return (await r.json()).csrfToken; }

    // Submit handler -> POST /api/register.php
    const form = document.getElementById('registerForm');
    const submitBtn = document.getElementById('submitBtn');

    submitBtn?.addEventListener('click', async () => {
      if (!form.checkValidity()) { alert('Please complete all required fields.'); return; }
      if (!isValidNPI(npiInput.value.trim())) { alert('Please validate your NPI.'); return; }
      if (!document.getElementById('agreeMSA').checked || !document.getElementById('agreeBAA').checked) {
        alert('You must agree to the MSA and BAA.'); return;
      }

      const payload = {
        email: document.getElementById('email').value.trim(),
        password: document.getElementById('password').value,
        practiceName: document.getElementById('practiceName').value.trim(),
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        npi: document.getElementById('npi').value.trim(),
        license: document.getElementById('license').value.trim(),
        licenseState: document.getElementById('licenseState').value,
        licenseExpiry: document.getElementById('licenseExpiry').value,
        accountType: document.querySelector('input[name="acctType"]:checked').value,
        dmeNumber: document.getElementById('dmeNumber')?.value || null,
        dmeState: document.getElementById('dmeState')?.value || null,
        dmeExpiry: document.getElementById('dmeExpiry')?.value || null,
        agreeMSA: document.getElementById('agreeMSA').checked,
        agreeBAA: document.getElementById('agreeBAA').checked,
        signName: document.getElementById('signName').value.trim(),
        signTitle: document.getElementById('signTitle').value.trim(),
        signDate: document.getElementById('signDate').value,
        phone: document.getElementById('phone')?.value || null
      };

      try {
        const token = await csrf();
        const res = await fetch('/api/register.php', {
          method:'POST',
          headers:{'Content-Type':'application/json','x-csrf-token':token},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        if (res.status === 201 || data.ok) {
          alert('Registration submitted successfully!');
          location.href = '/portal';
        } else {
          alert('Registration error: ' + (data.error || JSON.stringify(data)));
        }
      } catch (err) {
        alert('Network error. Please try again.');
        console.error(err);
      }
    });
  })();
  </script>
  <!-- === /YOUR ORIGINAL JS === -->

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
