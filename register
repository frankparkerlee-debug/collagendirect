<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Register — Physician Portal | CollagenDirect</title>
  <meta name="description" content="Create a secure CollagenDirect physician account to access ordering, documentation, and patient workflows." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#fafafa; --text:#1e2a38; --muted:#6b7280; --line:#e5e7eb;
      --brand:#5FA8A1; --brand-hover:#4d8d87;
      --radius:12px; --shadow:0 1px 3px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background: linear-gradient(to bottom right, #f8fafc 0%, #ffffff 50%, rgba(71, 198, 190, 0.03) 100%);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    img{max-width:100%;display:block}
    a{text-decoration:none;color:inherit}
    .container{max-width:1200px;margin:0 auto;padding:0 1.5rem}

    /* Simple header */
    header{
      background:#fff;
      border-bottom:1px solid var(--line);
      padding:1rem 0;
    }
    .nav{
      max-width:1200px;
      margin:0 auto;
      padding:0 1.5rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:32px;width:auto}
    .brand .title{font-weight:700;font-size:1rem;letter-spacing:.3px}

    /* Main content area */
    main{
      flex:1;
      padding:3rem 0;
    }
    .auth-card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:2.5rem;
      box-shadow:0 4px 6px -1px rgba(0,0,0,.05),0 2px 4px -1px rgba(0,0,0,.03);
      max-width:900px;
      margin:0 auto;
    }
    .auth-card h2{
      font-size:1.75rem;
      font-weight:700;
      color:#111;
      margin-bottom:0.5rem;
    }
    .muted{color:var(--muted)}
    .section-title{
      font-size:1.125rem;
      font-weight:600;
      color:#374151;
      margin-top:2rem;
      margin-bottom:1rem;
      padding-bottom:0.5rem;
      border-bottom:1px solid var(--line);
    }

    /* Form styling */
    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:1rem;
      margin-top:1rem;
    }
    .form-grid > div{
      display:flex;
      flex-direction:column;
      gap:0.5rem;
    }
    .form-grid.single{grid-template-columns:1fr}

    /* Inputs */
    .auth-card input,.auth-card select,.auth-card textarea{
      width:100%;
      padding:0.75rem 1rem;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      outline:none;
      font-size:0.95rem;
      transition:border-color 0.2s,box-shadow 0.2s;
    }
    .auth-card input::placeholder{color:#9ca3af}
    .auth-card input:focus,.auth-card select:focus,.auth-card textarea:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(95,168,161,.1);
    }
    label{
      display:block;
      font-weight:500;
      font-size:0.875rem;
      color:#374151;
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:0.875rem;
    }
    .row a{
      color:var(--brand);
      text-decoration:none;
      font-weight:500;
    }
    .row a:hover{text-decoration:underline}

    /* Buttons */
    .btn{
      padding:0.75rem 1.5rem;
      border-radius:var(--radius);
      font-weight:600;
      font-size:0.95rem;
      cursor:pointer;
      border:1px solid var(--line);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s;
      background:#fff;
      color:#374151;
    }
    .btn:hover{
      background:#f9fafb;
    }
    .btn.primary{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    .btn.primary:hover{
      background:var(--brand-hover);
    }
    .btn.ghost{
      background:#fff;
      border:1px solid var(--line);
      color:#374151;
    }
    .btn.ghost:hover{
      background:#f9fafb;
    }
    .btn.secondary{
      background:#f3f4f6;
      border:1px solid var(--line);
      color:#374151;
    }
    .btn.small{
      padding:0.5rem 1rem;
      font-size:0.875rem;
    }

    /* Status indicators */
    .status{
      padding:0.5rem 0.75rem;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:#fff;
      font-size:0.875rem;
    }
    .status.ok{
      border-color:#d1fae5;
      background:#ecfdf5;
      color:#065f46;
    }
    .status.bad{
      border-color:#fecaca;
      background:#fef2f2;
      color:#991b1b;
    }

    /* Fieldset styling */
    fieldset{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:1.5rem;
      margin-top:1rem;
    }
    legend{
      padding:0 0.5rem;
      font-weight:600;
      color:#374151;
    }

    /* User type selection cards */
    .user-type-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:1rem;
      margin-top:1rem;
    }
    .user-type-card{
      border:2px solid var(--line);
      border-radius:var(--radius);
      padding:1.5rem;
      cursor:pointer;
      transition:all 0.2s;
      background:#fff;
    }
    .user-type-card:hover{
      border-color:var(--brand);
      background:#f0fdfb;
    }
    .user-type-card input[type="radio"]{
      display:none;
    }
    .user-type-card input[type="radio"]:checked + .card-content{
      border-left:4px solid var(--brand);
      padding-left:1rem;
    }
    .user-type-card.selected{
      border-color:var(--brand);
      background:#f0fdfb;
    }
    .card-content h3{
      font-size:1rem;
      font-weight:600;
      color:#111;
      margin-bottom:0.5rem;
    }
    .card-content p{
      font-size:0.875rem;
      color:var(--muted);
    }

    /* Physician item in "Add More" list */
    .physician-item{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:1rem;
      margin-top:0.75rem;
      background:#f9fafb;
      position:relative;
    }
    .physician-item-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:0.75rem;
    }
    .physician-item-header h4{
      font-size:0.95rem;
      font-weight:600;
      color:#374151;
    }
    .btn-remove{
      background:#fee;
      border:1px solid #fecaca;
      color:#991b1b;
      padding:0.25rem 0.75rem;
      font-size:0.8rem;
      border-radius:8px;
      cursor:pointer;
      font-weight:500;
    }
    .btn-remove:hover{
      background:#fecaca;
    }

    /* Footer */
    footer{
      background:#fff;
      border-top:1px solid var(--line);
      padding:1rem;
      text-align:center;
      color:var(--muted);
      font-size:0.875rem;
    }

    /* Utility classes */
    [hidden]{display:none !important}

    /* Field validation styles */
    .field-error input,
    .field-error select{
      border-color:#dc2626 !important;
      background:#fef2f2;
    }
    .field-error input:focus,
    .field-error select:focus{
      border-color:#dc2626 !important;
      box-shadow:0 0 0 3px rgba(220,38,38,.1) !important;
    }
    .error-message{
      color:#dc2626;
      font-size:0.875rem;
      margin-top:0.25rem;
      display:none;
    }
    .field-error .error-message{
      display:block;
    }
    .validation-summary{
      background:#fef2f2;
      border:1px solid #fecaca;
      border-radius:var(--radius);
      padding:1rem;
      margin-bottom:1.5rem;
      display:none;
    }
    .validation-summary.show{
      display:block;
    }
    .validation-summary h3{
      color:#991b1b;
      font-size:1rem;
      font-weight:600;
      margin-bottom:0.5rem;
    }
    .validation-summary ul{
      list-style:none;
      padding:0;
      margin:0;
    }
    .validation-summary li{
      color:#991b1b;
      font-size:0.875rem;
      padding:0.25rem 0;
      padding-left:1.5rem;
      position:relative;
    }
    .validation-summary li:before{
      content:"•";
      position:absolute;
      left:0.5rem;
    }

    /* Responsive */
    @media (max-width:768px){
      .form-grid{grid-template-columns:1fr}
      .user-type-grid{grid-template-columns:1fr}
      .auth-card{padding:1.5rem}
      .auth-card h2{font-size:1.5rem}
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <a href="/index.html" class="brand" aria-label="Go to homepage">
        <img src="/assets/collagendirect.png" alt="CollagenDirect logo">
        <span class="title">COLLAGEN <span style="color:#5FA8A1">DIRECT</span></span>
      </a>
    </div>
  </header>

  <main class="container">
    <section class="auth-card">
      <h2>Create Your Account</h2>
      <p class="muted">Already have an account? <a href="/portal" style="color:var(--brand);font-weight:500">Sign in</a></p>

      <form id="registerForm" novalidate action="javascript:void(0)">

        <!-- Validation Summary -->
        <div id="validationSummary" class="validation-summary">
          <h3>Please correct the following errors:</h3>
          <ul id="validationList"></ul>
        </div>

        <!-- Step 1: User Type Selection -->
        <section class="card" style="border:none;box-shadow:none;padding:0">
          <h2 class="section-title" style="margin:0 0 8px">Select Your Account Type</h2>
          <p class="muted" style="margin-bottom:1rem">Choose the option that best describes your practice</p>

          <div class="user-type-grid">
            <!-- 1a. Practice Manager / Admin (Non-DME) -->
            <label class="user-type-card" data-type="practice_admin">
              <input type="radio" name="userType" value="practice_admin" required />
              <div class="card-content">
                <h3>Practice Manager / Admin</h3>
                <p>Manage practice details, physicians, and refer patients. No DME license required.</p>
              </div>
            </label>

            <!-- 1b. Physician (Non-DME, part of practice) -->
            <label class="user-type-card" data-type="physician">
              <input type="radio" name="userType" value="physician" />
              <div class="card-content">
                <h3>Physician</h3>
                <p>Join an existing practice. Sign orders for your own patients.</p>
              </div>
            </label>

            <!-- 2a. DME Hybrid Referrer -->
            <label class="user-type-card" data-type="dme_hybrid">
              <input type="radio" name="userType" value="dme_hybrid" />
              <div class="card-content">
                <h3>DME Hybrid Referrer</h3>
                <p>Hold a DME license. Mix of referrals and direct billing on a case-by-case basis.</p>
              </div>
            </label>

            <!-- 2b. DME Wholesale Only -->
            <label class="user-type-card" data-type="dme_wholesale">
              <input type="radio" name="userType" value="dme_wholesale" />
              <div class="card-content">
                <h3>DME Wholesale Only</h3>
                <p>Hold a DME license. Direct bill all patients and purchase products wholesale.</p>
              </div>
            </label>
          </div>
        </section>

        <!-- Step 2: Account Credentials -->
        <section class="card" aria-labelledby="acct-title" style="border:none;box-shadow:none;padding:0">
          <h2 id="acct-title" class="section-title">Account Credentials</h2>
          <div class="form-grid">
            <div id="field-email">
              <label for="email">Work Email</label>
              <input id="email" type="email" required placeholder="name@practice.com" />
              <div class="error-message">Please enter a valid email address</div>
              <div class="muted" style="font-size:.9rem">Used for login and agreement copies</div>
            </div>
            <div id="field-password">
              <label for="password">Password</label>
              <input id="password" type="password" minlength="8" required placeholder="••••••••" />
              <div class="error-message">Password must be at least 8 characters</div>
              <div class="muted" style="font-size:.9rem">Min 8 characters, include a number</div>
            </div>
          </div>
        </section>

        <!-- Step 3: Practice Information (for practice_admin, dme_hybrid, dme_wholesale) -->
        <section id="practiceInfoSection" class="card" aria-labelledby="practice-title" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 id="practice-title" class="section-title">Practice Information</h2>
          <div class="form-grid">
            <div id="field-practiceName">
              <label for="practiceName">Practice / Facility Name</label>
              <input id="practiceName" />
              <div class="error-message">Practice name is required</div>
            </div>
            <div id="field-taxId">
              <label for="taxId">Tax ID (optional)</label>
              <input id="taxId" placeholder="##-#######" />
            </div>
            <div id="field-address">
              <label for="address">Street Address</label>
              <input id="address" />
              <div class="error-message">Street address is required</div>
            </div>
            <div id="field-city">
              <label for="city">City</label>
              <input id="city" />
              <div class="error-message">City is required</div>
            </div>
            <div id="field-state">
              <label for="state">State</label>
              <select id="state"></select>
              <div class="error-message">State is required</div>
            </div>
            <div id="field-zip">
              <label for="zip">ZIP</label>
              <input id="zip" pattern="\d{5}(-\d{4})?" placeholder="12345" />
              <div class="error-message">ZIP code is required</div>
            </div>
            <div id="field-phone">
              <label for="phone">Practice Phone</label>
              <input id="phone" type="tel" placeholder="(555) 555-5555" />
              <div class="error-message">Phone number is required</div>
            </div>
          </div>
        </section>

        <!-- Step 4: Physician Credentials (shown for all types) -->
        <section id="physicianCredsSection" class="card" aria-labelledby="cred-title" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 id="cred-title" class="section-title">Physician Credentials</h2>
          <div class="form-grid">
            <div id="field-firstName">
              <label for="firstName">First Name</label>
              <input id="firstName" />
              <div class="error-message">First name is required</div>
            </div>
            <div id="field-lastName">
              <label for="lastName">Last Name</label>
              <input id="lastName" />
              <div class="error-message">Last name is required</div>
            </div>
            <div id="field-npi">
              <label for="npi">NPI Number</label>
              <input id="npi" inputmode="numeric" pattern="\d{10}" placeholder="10 digits" />
              <div class="error-message">NPI number is required</div>
            </div>
          </div>
          <div class="form-grid" style="margin-top:12px">
            <div id="field-license">
              <label for="license">Medical License #</label>
              <input id="license" />
              <div class="error-message">Medical license is required</div>
            </div>
            <div id="field-licenseState">
              <label for="licenseState">License State</label>
              <select id="licenseState"></select>
              <div class="error-message">License state is required</div>
            </div>
            <div id="field-licenseExpiry">
              <label for="licenseExpiry">License Expiry</label>
              <input id="licenseExpiry" type="date" />
              <div class="error-message">License expiry is required</div>
            </div>
          </div>
          <div class="row" style="margin-top:10px;gap:12px">
            <button type="button" class="btn" id="btnValidateNPI">Validate NPI</button>
            <span id="npiStatus" class="status" aria-live="polite">NPI not validated</span>
          </div>
        </section>

        <!-- Step 5: Additional Physicians (for practice_admin only) -->
        <section id="additionalPhysiciansSection" class="card" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 class="section-title">Additional Physicians (Optional)</h2>
          <p class="muted" style="margin-bottom:1rem">Add other physicians in your practice who will use this portal</p>

          <div id="additionalPhysiciansList"></div>

          <button type="button" class="btn secondary small" id="btnAddPhysician" style="margin-top:1rem">
            + Add Another Physician
          </button>
        </section>

        <!-- Step 6: Practice Manager Link (for physician type only) -->
        <section id="practiceManagerLinkSection" class="card" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 class="section-title">Link to Practice Manager</h2>
          <p class="muted" style="margin-bottom:1rem">Enter your practice manager's email or practice code to link your account</p>
          <div class="form-grid single">
            <div id="field-practiceManagerEmail">
              <label for="practiceManagerEmail">Practice Manager Email</label>
              <input id="practiceManagerEmail" type="email" placeholder="manager@practice.com" />
              <div class="error-message">Practice manager email is required</div>
              <div class="muted" style="font-size:.9rem">Your practice manager will need to approve your access</div>
            </div>
          </div>
        </section>

        <!-- Step 7: DME License Information (for dme_hybrid and dme_wholesale) -->
        <section id="dmeSection" class="card" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 class="section-title">DME License Information</h2>
          <div class="form-grid">
            <div id="field-dmeNumber">
              <label for="dmeNumber">DME License #</label>
              <input id="dmeNumber" />
              <div class="error-message">DME license number is required</div>
            </div>
            <div id="field-dmeState">
              <label for="dmeState">DME State</label>
              <select id="dmeState"></select>
              <div class="error-message">DME state is required</div>
            </div>
            <div id="field-dmeExpiry">
              <label for="dmeExpiry">DME Expiry</label>
              <input id="dmeExpiry" type="date" />
              <div class="error-message">DME expiry date is required</div>
            </div>
          </div>
        </section>

        <!-- Step 8: Agreements & e-Sign -->
        <section id="agreementsSection" class="card" aria-labelledby="agreements-title" style="border:none;box-shadow:none;padding:0;margin-top:18px" hidden>
          <h2 id="agreements-title" class="section-title">Agreements & e-Sign</h2>
          <div class="form-grid">
            <div id="field-agreeMSA">
              <label>Master Services & Supply Agreement</label>
              <div class="row" style="gap:12px">
                <button type="button" class="btn" data-open="msaa">Preview</button>
                <label class="row" style="gap:8px"><input id="agreeMSA" type="checkbox" /> <span>I agree</span></label>
              </div>
              <div class="error-message">You must agree to the MSA</div>
            </div>
            <div id="field-agreeBAA">
              <label>Business Associate Agreement (BAA)</label>
              <div class="row" style="gap:12px">
                <button type="button" class="btn" data-open="baa">Preview</button>
                <label class="row" style="gap:8px"><input id="agreeBAA" type="checkbox" /> <span>I agree</span></label>
              </div>
              <div class="error-message">You must agree to the BAA</div>
            </div>
          </div>
          <div class="form-grid" style="margin-top:10px">
            <div id="field-signName">
              <label for="signName">Full Legal Name (Signature)</label>
              <input id="signName" />
              <div class="error-message">Signature name is required</div>
            </div>
            <div id="field-signTitle">
              <label for="signTitle">Title</label>
              <input id="signTitle" placeholder="MD, DO, etc." />
              <div class="error-message">Title is required</div>
            </div>
            <div id="field-signDate">
              <label for="signDate">Date</label>
              <input id="signDate" type="date" />
              <div class="error-message">Date is required</div>
            </div>
          </div>
        </section>

        <div class="row" style="margin-top:2rem;gap:12px;flex-wrap:wrap">
          <button id="submitBtn" type="button" class="btn primary">Create Account</button>
          <a class="btn ghost" href="/portal">Already registered? Log in</a>
        </div>

        <p class="muted" style="margin-top:1.5rem;text-align:center;font-size:0.875rem">
          For assistance, contact <a href="mailto:support@collagendirect.health" style="color:var(--brand);font-weight:500">support@collagendirect.health</a>
        </p>
      </form>
    </section>
  </main>

  <footer>
    © <span id="year"></span> CollagenDirect. All rights reserved.
  </footer>

  <script>
  (function () {
    // Populate state selects
    const states = ["AL","AK","AZ","AR","CA","CO","CT","DC","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA","WI","WV","WY"];
    for (const id of ["state","licenseState","dmeState"]) {
      const el = document.getElementById(id);
      if (!el) continue;
      el.append(new Option("Select",""));
      states.forEach(s => el.append(new Option(s, s)));
    }

    // Default sign date
    const today = new Date().toISOString().slice(0,10);
    const signDate = document.getElementById('signDate');
    if (signDate) signDate.value = today;

    // Track additional physicians
    let additionalPhysicians = [];
    let physicianCounter = 0;

    // User type selection logic
    const userTypeCards = document.querySelectorAll('.user-type-card');
    const practiceInfoSection = document.getElementById('practiceInfoSection');
    const physicianCredsSection = document.getElementById('physicianCredsSection');
    const additionalPhysiciansSection = document.getElementById('additionalPhysiciansSection');
    const practiceManagerLinkSection = document.getElementById('practiceManagerLinkSection');
    const dmeSection = document.getElementById('dmeSection');
    const agreementsSection = document.getElementById('agreementsSection');

    userTypeCards.forEach(card => {
      card.addEventListener('click', function() {
        // Update visual selection
        userTypeCards.forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');

        // Check the radio button
        const radio = this.querySelector('input[type="radio"]');
        radio.checked = true;

        // Get selected type
        const selectedType = radio.value;

        // Show/hide sections based on user type
        if (selectedType === 'practice_admin') {
          // Practice Manager: Show practice info, physician creds, additional physicians, agreements
          practiceInfoSection.hidden = false;
          physicianCredsSection.hidden = false;
          additionalPhysiciansSection.hidden = false;
          practiceManagerLinkSection.hidden = true;
          dmeSection.hidden = true;
          agreementsSection.hidden = false;

          // Set required fields
          setRequired(['practiceName', 'address', 'city', 'state', 'zip', 'phone', 'firstName', 'lastName', 'npi', 'license', 'licenseState', 'licenseExpiry', 'agreeMSA', 'agreeBAA', 'signName', 'signTitle', 'signDate']);
          setOptional(['dmeNumber', 'dmeState', 'dmeExpiry', 'practiceManagerEmail']);

        } else if (selectedType === 'physician') {
          // Physician: Show physician creds, practice manager link, agreements only
          practiceInfoSection.hidden = true;
          physicianCredsSection.hidden = false;
          additionalPhysiciansSection.hidden = true;
          practiceManagerLinkSection.hidden = false;
          dmeSection.hidden = true;
          agreementsSection.hidden = false;

          // Set required fields
          setRequired(['firstName', 'lastName', 'npi', 'license', 'licenseState', 'licenseExpiry', 'practiceManagerEmail', 'agreeMSA', 'agreeBAA', 'signName', 'signTitle', 'signDate']);
          setOptional(['practiceName', 'address', 'city', 'state', 'zip', 'phone', 'dmeNumber', 'dmeState', 'dmeExpiry']);

        } else if (selectedType === 'dme_hybrid' || selectedType === 'dme_wholesale') {
          // DME Users: Show practice info, physician creds, DME info, agreements
          practiceInfoSection.hidden = false;
          physicianCredsSection.hidden = false;
          additionalPhysiciansSection.hidden = true;
          practiceManagerLinkSection.hidden = true;
          dmeSection.hidden = false;
          agreementsSection.hidden = false;

          // Set required fields
          setRequired(['practiceName', 'address', 'city', 'state', 'zip', 'phone', 'firstName', 'lastName', 'npi', 'license', 'licenseState', 'licenseExpiry', 'dmeNumber', 'dmeState', 'dmeExpiry', 'agreeMSA', 'agreeBAA', 'signName', 'signTitle', 'signDate']);
          setOptional(['practiceManagerEmail']);
        }
      });
    });

    function setRequired(fields) {
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.required = true;
      });
    }

    function setOptional(fields) {
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.required = false;
      });
    }

    // Add physician functionality
    const btnAddPhysician = document.getElementById('btnAddPhysician');
    const additionalPhysiciansList = document.getElementById('additionalPhysiciansList');

    btnAddPhysician?.addEventListener('click', () => {
      physicianCounter++;
      const physicianId = `physician_${physicianCounter}`;

      const physicianItem = document.createElement('div');
      physicianItem.className = 'physician-item';
      physicianItem.id = physicianId;
      physicianItem.innerHTML = `
        <div class="physician-item-header">
          <h4>Physician ${physicianCounter}</h4>
          <button type="button" class="btn-remove" data-physician-id="${physicianId}">Remove</button>
        </div>
        <div class="form-grid">
          <div>
            <label>First Name</label>
            <input type="text" data-field="firstName" data-physician-id="${physicianId}" required />
          </div>
          <div>
            <label>Last Name</label>
            <input type="text" data-field="lastName" data-physician-id="${physicianId}" required />
          </div>
          <div>
            <label>NPI Number</label>
            <input type="text" data-field="npi" data-physician-id="${physicianId}" pattern="\\d{10}" placeholder="10 digits" required />
          </div>
          <div>
            <label>Medical License #</label>
            <input type="text" data-field="license" data-physician-id="${physicianId}" required />
          </div>
          <div>
            <label>License State</label>
            <select data-field="licenseState" data-physician-id="${physicianId}" required>
              <option value="">Select</option>
              ${states.map(s => `<option value="${s}">${s}</option>`).join('')}
            </select>
          </div>
          <div>
            <label>License Expiry</label>
            <input type="date" data-field="licenseExpiry" data-physician-id="${physicianId}" required />
          </div>
          <div>
            <label>Email (optional)</label>
            <input type="email" data-field="email" data-physician-id="${physicianId}" placeholder="physician@practice.com" />
          </div>
          <div>
            <label>Phone (optional)</label>
            <input type="tel" data-field="phone" data-physician-id="${physicianId}" placeholder="(555) 555-5555" />
          </div>
        </div>
      `;

      additionalPhysiciansList.appendChild(physicianItem);

      // Add remove handler
      physicianItem.querySelector('.btn-remove').addEventListener('click', function() {
        const id = this.dataset.physicianId;
        document.getElementById(id)?.remove();
        additionalPhysicians = additionalPhysicians.filter(p => p.id !== id);
      });
    });

    // Collect additional physicians data
    function collectAdditionalPhysicians() {
      const physicians = [];
      const items = additionalPhysiciansList.querySelectorAll('.physician-item');

      items.forEach(item => {
        const physicianId = item.id;
        const inputs = item.querySelectorAll(`[data-physician-id="${physicianId}"]`);
        const physician = {};

        inputs.forEach(input => {
          const field = input.dataset.field;
          physician[field] = input.value.trim();
        });

        if (physician.firstName && physician.lastName && physician.npi) {
          physicians.push(physician);
        }
      });

      return physicians;
    }

    // NPI validation
    function isValidNPI(npi){
      if(!/^\d{10}$/.test(npi)) return false;
      const prefix = '80840' + npi.slice(0,9);
      const digits = prefix.split('').map(Number);
      for (let i = digits.length - 1; i >= 0; i -= 2){ digits[i] *= 2; if (digits[i] > 9) digits[i] -= 9; }
      const sum = digits.reduce((a,b)=>a+b,0);
      const check = (10 - (sum % 10)) % 10;
      return check === Number(npi[9]);
    }

    const btnValidate = document.getElementById('btnValidateNPI');
    const npiInput = document.getElementById('npi');
    const npiStatus = document.getElementById('npiStatus');
    btnValidate?.addEventListener('click',()=>{
      const ok = isValidNPI(npiInput.value.trim());
      npiStatus.textContent = ok ? 'NPI format valid (checksum passed)' : 'Invalid NPI number';
      npiStatus.className = 'status ' + (ok ? 'ok' : 'bad');
    });

    // CSRF helper
    async function csrf(){ const r = await fetch('/api/csrf.php',{credentials:'include'}); return (await r.json()).csrfToken; }

    // Validation helper functions
    function clearValidationErrors() {
      document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
      document.getElementById('validationSummary').classList.remove('show');
      document.getElementById('validationList').innerHTML = '';
    }

    function showValidationError(fieldId, message) {
      const field = document.getElementById(fieldId) || document.querySelector(`#${fieldId}`);
      if (field) {
        field.classList.add('field-error');
      }

      const list = document.getElementById('validationList');
      const li = document.createElement('li');
      li.textContent = message;
      list.appendChild(li);
    }

    function validateForm() {
      clearValidationErrors();
      const errors = [];
      const selectedType = document.querySelector('input[name="userType"]:checked');

      // 1. Check user type selection
      if (!selectedType) {
        errors.push({ field: null, message: 'Please select an account type' });
      }

      // 2. Validate email
      const email = document.getElementById('email');
      if (!email.value.trim()) {
        errors.push({ field: 'field-email', message: 'Email is required' });
      } else if (!email.value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        errors.push({ field: 'field-email', message: 'Please enter a valid email address' });
      }

      // 3. Validate password
      const password = document.getElementById('password');
      if (!password.value) {
        errors.push({ field: 'field-password', message: 'Password is required' });
      } else if (password.value.length < 8) {
        errors.push({ field: 'field-password', message: 'Password must be at least 8 characters' });
      }

      if (!selectedType) {
        // Show errors and stop if no type selected
        if (errors.length > 0) {
          errors.forEach(err => {
            if (err.field) showValidationError(err.field, err.message);
            else {
              const list = document.getElementById('validationList');
              const li = document.createElement('li');
              li.textContent = err.message;
              list.appendChild(li);
            }
          });
          document.getElementById('validationSummary').classList.add('show');
          document.getElementById('validationSummary').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        return false;
      }

      const userType = selectedType.value;

      // Type-specific validation
      if (userType === 'practice_admin') {
        // Practice info required
        if (!document.getElementById('practiceName').value.trim()) {
          errors.push({ field: 'field-practiceName', message: 'Practice name is required' });
        }
        if (!document.getElementById('address').value.trim()) {
          errors.push({ field: 'field-address', message: 'Street address is required' });
        }
        if (!document.getElementById('city').value.trim()) {
          errors.push({ field: 'field-city', message: 'City is required' });
        }
        if (!document.getElementById('state').value) {
          errors.push({ field: 'field-state', message: 'State is required' });
        }
        if (!document.getElementById('zip').value.trim()) {
          errors.push({ field: 'field-zip', message: 'ZIP code is required' });
        }
        if (!document.getElementById('phone').value.trim()) {
          errors.push({ field: 'field-phone', message: 'Phone number is required' });
        }
      }

      if (userType === 'physician') {
        // Practice manager email required
        if (!document.getElementById('practiceManagerEmail').value.trim()) {
          errors.push({ field: 'field-practiceManagerEmail', message: 'Practice manager email is required' });
        }
      }

      if (userType === 'dme_hybrid' || userType === 'dme_wholesale') {
        // Practice info + DME license required
        if (!document.getElementById('practiceName').value.trim()) {
          errors.push({ field: 'field-practiceName', message: 'Practice name is required' });
        }
        if (!document.getElementById('address').value.trim()) {
          errors.push({ field: 'field-address', message: 'Street address is required' });
        }
        if (!document.getElementById('city').value.trim()) {
          errors.push({ field: 'field-city', message: 'City is required' });
        }
        if (!document.getElementById('state').value) {
          errors.push({ field: 'field-state', message: 'State is required' });
        }
        if (!document.getElementById('zip').value.trim()) {
          errors.push({ field: 'field-zip', message: 'ZIP code is required' });
        }
        if (!document.getElementById('phone').value.trim()) {
          errors.push({ field: 'field-phone', message: 'Phone number is required' });
        }
        if (!document.getElementById('dmeNumber').value.trim()) {
          errors.push({ field: 'field-dmeNumber', message: 'DME license number is required' });
        }
        if (!document.getElementById('dmeState').value) {
          errors.push({ field: 'field-dmeState', message: 'DME state is required' });
        }
        if (!document.getElementById('dmeExpiry').value) {
          errors.push({ field: 'field-dmeExpiry', message: 'DME expiry date is required' });
        }
      }

      // Physician credentials (required for all types)
      if (!document.getElementById('firstName').value.trim()) {
        errors.push({ field: 'field-firstName', message: 'First name is required' });
      }
      if (!document.getElementById('lastName').value.trim()) {
        errors.push({ field: 'field-lastName', message: 'Last name is required' });
      }
      if (!document.getElementById('npi').value.trim()) {
        errors.push({ field: 'field-npi', message: 'NPI number is required' });
      } else if (!isValidNPI(document.getElementById('npi').value.trim())) {
        errors.push({ field: 'field-npi', message: 'Please enter a valid NPI number (click Validate NPI)' });
      }
      if (!document.getElementById('license').value.trim()) {
        errors.push({ field: 'field-license', message: 'Medical license number is required' });
      }
      if (!document.getElementById('licenseState').value) {
        errors.push({ field: 'field-licenseState', message: 'License state is required' });
      }
      if (!document.getElementById('licenseExpiry').value) {
        errors.push({ field: 'field-licenseExpiry', message: 'License expiry date is required' });
      }

      // Agreements
      if (!document.getElementById('agreeMSA').checked) {
        errors.push({ field: 'field-agreeMSA', message: 'You must agree to the Master Services Agreement' });
      }
      if (!document.getElementById('agreeBAA').checked) {
        errors.push({ field: 'field-agreeBAA', message: 'You must agree to the Business Associate Agreement' });
      }
      if (!document.getElementById('signName').value.trim()) {
        errors.push({ field: 'field-signName', message: 'Signature name is required' });
      }
      if (!document.getElementById('signTitle').value.trim()) {
        errors.push({ field: 'field-signTitle', message: 'Signature title is required' });
      }
      if (!document.getElementById('signDate').value) {
        errors.push({ field: 'field-signDate', message: 'Signature date is required' });
      }

      // Display errors if any
      if (errors.length > 0) {
        errors.forEach(err => {
          if (err.field) showValidationError(err.field, err.message);
          else {
            const list = document.getElementById('validationList');
            const li = document.createElement('li');
            li.textContent = err.message;
            list.appendChild(li);
          }
        });
        document.getElementById('validationSummary').classList.add('show');
        document.getElementById('validationSummary').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        return false;
      }

      return true;
    }

    // Submit handler
    const form = document.getElementById('registerForm');
    const submitBtn = document.getElementById('submitBtn');

    submitBtn?.addEventListener('click', async () => {
      // Run comprehensive validation
      if (!validateForm()) {
        return;
      }

      const selectedType = document.querySelector('input[name="userType"]:checked');

      const payload = {
        userType: selectedType.value,
        email: document.getElementById('email').value.trim(),
        password: document.getElementById('password').value,
        firstName: document.getElementById('firstName')?.value.trim() || null,
        lastName: document.getElementById('lastName')?.value.trim() || null,
        npi: document.getElementById('npi')?.value.trim() || null,
        license: document.getElementById('license')?.value.trim() || null,
        licenseState: document.getElementById('licenseState')?.value || null,
        licenseExpiry: document.getElementById('licenseExpiry')?.value || null,
        practiceName: document.getElementById('practiceName')?.value.trim() || null,
        taxId: document.getElementById('taxId')?.value.trim() || null,
        address: document.getElementById('address')?.value.trim() || null,
        city: document.getElementById('city')?.value.trim() || null,
        state: document.getElementById('state')?.value || null,
        zip: document.getElementById('zip')?.value.trim() || null,
        phone: document.getElementById('phone')?.value.trim() || null,
        dmeNumber: document.getElementById('dmeNumber')?.value.trim() || null,
        dmeState: document.getElementById('dmeState')?.value || null,
        dmeExpiry: document.getElementById('dmeExpiry')?.value || null,
        practiceManagerEmail: document.getElementById('practiceManagerEmail')?.value.trim() || null,
        additionalPhysicians: selectedType.value === 'practice_admin' ? collectAdditionalPhysicians() : [],
        agreeMSA: document.getElementById('agreeMSA').checked,
        agreeBAA: document.getElementById('agreeBAA').checked,
        signName: document.getElementById('signName').value.trim(),
        signTitle: document.getElementById('signTitle').value.trim(),
        signDate: document.getElementById('signDate').value
      };

      try {
        const token = await csrf();
        const res = await fetch('/api/register.php', {
          method:'POST',
          headers:{'Content-Type':'application/json','x-csrf-token':token},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        if (res.status === 201 || data.ok) {
          alert('Registration submitted successfully!');
          location.href = '/portal';
        } else {
          alert('Registration error: ' + (data.error || JSON.stringify(data)));
        }
      } catch (err) {
        alert('Network error. Please try again.');
        console.error(err);
      }
    });

    // Set year in footer
    document.getElementById('year').textContent = new Date().getFullYear();
  })();
  </script>
</body>
</html>
