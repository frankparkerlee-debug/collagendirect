<!-- Order Edit Dialog -->
<dialog id="dlg-order-edit" class="rounded-2xl w-full max-w-4xl">
  <form class="p-0" id="form-order-edit">
    <div class="p-5 border-b flex items-center justify-between bg-slate-50">
      <h3 class="text-lg font-semibold">Edit Order</h3>
      <button class="btn" type="button" onclick="document.getElementById('dlg-order-edit').close()">Cancel</button>
    </div>

    <div class="p-6 max-h-[70vh] overflow-y-auto">
      <input type="hidden" id="edit-order-id" name="order_id">

      <!-- Wound Details Section -->
      <div class="mb-6">
        <h4 class="font-semibold text-md mb-3 pb-2 border-b">Wound Details</h4>

        <div id="edit-wounds-container" class="space-y-4">
          <!-- Wounds will be dynamically populated here -->
        </div>

        <button type="button" onclick="addEditWound()" class="btn btn-sm mt-3">+ Add Wound</button>

        <div class="mt-4">
          <label class="block text-sm font-medium mb-1">Additional Clinical Notes</label>
          <textarea
            id="edit-wound-notes"
            name="wound_notes"
            rows="3"
            class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
            placeholder="Additional wound description or clinical observations..."
          ></textarea>
        </div>
      </div>

      <!-- Treatment Frequency Section -->
      <div class="mb-6">
        <h4 class="font-semibold text-md mb-3 pb-2 border-b">Treatment Information</h4>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Treatment Frequency *</label>
            <select
              id="edit-frequency"
              name="frequency"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              required
            >
              <option value="">Select frequency</option>
              <option value="1x per week">1x per week</option>
              <option value="2x per week">2x per week</option>
              <option value="3x per week">3x per week</option>
              <option value="Daily">Daily</option>
              <option value="Every other day">Every other day</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Delivery Mode</label>
            <select
              id="edit-delivery-mode"
              name="delivery_mode"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
            >
              <option value="standard">Ship to Patient</option>
              <option value="office">Deliver to Office</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Shipping Information Section -->
      <div class="mb-6" id="edit-shipping-section">
        <h4 class="font-semibold text-md mb-3 pb-2 border-b">Shipping Address</h4>
        <div class="grid gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Recipient Name *</label>
            <input
              type="text"
              id="edit-shipping-name"
              name="shipping_name"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Full name"
            >
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Street Address *</label>
            <input
              type="text"
              id="edit-shipping-address"
              name="shipping_address"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Street address"
            >
          </div>

          <div class="grid md:grid-cols-3 gap-4">
            <div class="md:col-span-1">
              <label class="block text-sm font-medium mb-1">City *</label>
              <input
                type="text"
                id="edit-shipping-city"
                name="shipping_city"
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                placeholder="City"
              >
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">State *</label>
              <select
                id="edit-shipping-state"
                name="shipping_state"
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Select state</option>
                <!-- States will be populated by JavaScript -->
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">ZIP Code *</label>
              <input
                type="text"
                id="edit-shipping-zip"
                name="shipping_zip"
                pattern="\d{5}"
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                placeholder="12345"
              >
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Phone Number</label>
            <input
              type="tel"
              id="edit-shipping-phone"
              name="shipping_phone"
              pattern="\d{10}"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="1234567890 (10 digits)"
            >
          </div>
        </div>
      </div>

      <!-- Insurance Information Section -->
      <div class="mb-6" id="edit-insurance-section">
        <h4 class="font-semibold text-md mb-3 pb-2 border-b">Insurance Information</h4>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Insurance Provider</label>
            <input
              type="text"
              id="edit-insurer-name"
              name="insurer_name"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Insurance company name"
            >
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Member ID</label>
            <input
              type="text"
              id="edit-member-id"
              name="member_id"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Member/Policy ID"
            >
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Group Number</label>
            <input
              type="text"
              id="edit-group-id"
              name="group_id"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Group number"
            >
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Payer Phone</label>
            <input
              type="tel"
              id="edit-payer-phone"
              name="payer_phone"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Insurance contact number"
            >
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Prior Authorization Number</label>
            <input
              type="text"
              id="edit-prior-auth"
              name="prior_auth"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Prior auth # (if applicable)"
            >
          </div>
        </div>
      </div>

      <!-- Revision Reason -->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-1">Reason for Changes (Optional)</label>
        <textarea
          id="edit-reason"
          name="reason"
          rows="2"
          class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
          placeholder="Brief explanation of why you're updating this order..."
        ></textarea>
      </div>
    </div>

    <div class="p-5 border-t bg-slate-50 flex justify-end gap-3">
      <button
        type="button"
        class="btn"
        onclick="document.getElementById('dlg-order-edit').close()"
      >
        Cancel
      </button>
      <button
        type="submit"
        class="btn btn-primary"
        id="btn-order-edit-save"
      >
        Save Changes
      </button>
    </div>
  </form>
</dialog>

<script>
// ICD-10 Autocomplete Function
window.attachIcd10Autocomplete = function(inputElement) {
  if (!inputElement) return;

  let autocompleteList = null;
  let currentFocus = -1;
  let abortController = null;

  // Create autocomplete list container
  function createAutocompleteList() {
    if (autocompleteList) return autocompleteList;

    autocompleteList = document.createElement('div');
    autocompleteList.className = 'icd10-autocomplete-list';
    autocompleteList.style.cssText = `
      position: absolute;
      z-index: 9999;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      max-height: 200px;
      overflow-y: auto;
      display: none;
    `;

    inputElement.parentNode.style.position = 'relative';
    inputElement.parentNode.appendChild(autocompleteList);

    return autocompleteList;
  }

  // Close autocomplete list
  function closeAutocomplete() {
    if (autocompleteList) {
      autocompleteList.style.display = 'none';
      autocompleteList.innerHTML = '';
    }
    currentFocus = -1;
  }

  // Highlight active item
  function setActive(items) {
    if (!items || items.length === 0) return;
    items.forEach((item, index) => {
      if (index === currentFocus) {
        item.classList.add('autocomplete-active');
        item.style.background = '#3b82f6';
        item.style.color = 'white';
      } else {
        item.classList.remove('autocomplete-active');
        item.style.background = '';
        item.style.color = '';
      }
    });
  }

  // Handle input event
  inputElement.addEventListener('input', async function() {
    const value = this.value.trim();

    // Close if less than 2 characters
    if (value.length < 2) {
      closeAutocomplete();
      return;
    }

    // Abort previous request
    if (abortController) {
      abortController.abort();
    }

    abortController = new AbortController();

    try {
      const response = await fetch(`/api/icd10_search.php?term=${encodeURIComponent(value)}`, {
        signal: abortController.signal
      });

      const data = await response.json();

      if (data.success && data.results && data.results.length > 0) {
        const list = createAutocompleteList();
        list.innerHTML = '';
        list.style.display = 'block';

        // Position list below input
        const rect = inputElement.getBoundingClientRect();
        const parentRect = inputElement.parentNode.getBoundingClientRect();
        list.style.top = (rect.bottom - parentRect.top) + 'px';
        list.style.left = (rect.left - parentRect.left) + 'px';
        list.style.width = rect.width + 'px';

        data.results.forEach((result) => {
          const item = document.createElement('div');
          item.style.cssText = `
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
            border-bottom: 1px solid #f3f4f6;
          `;

          item.innerHTML = `
            <div style="font-weight: 500;">${result.code}</div>
            <div style="color: #6b7280; font-size: 0.75rem;">${result.description}</div>
          `;

          item.addEventListener('click', function() {
            inputElement.value = `${result.code} - ${result.description}`;
            closeAutocomplete();
          });

          item.addEventListener('mouseenter', function() {
            this.style.background = '#3b82f6';
            this.style.color = 'white';
          });

          item.addEventListener('mouseleave', function() {
            if (!this.classList.contains('autocomplete-active')) {
              this.style.background = '';
              this.style.color = '';
            }
          });

          list.appendChild(item);
        });
      } else {
        closeAutocomplete();
      }
    } catch (error) {
      if (error.name !== 'AbortError') {
        console.error('ICD-10 search error:', error);
      }
    }
  });

  // Handle keyboard navigation
  inputElement.addEventListener('keydown', function(e) {
    if (!autocompleteList || autocompleteList.style.display === 'none') return;

    const items = autocompleteList.querySelectorAll('div[style*="cursor: pointer"]');

    if (e.keyCode === 40) { // Down arrow
      e.preventDefault();
      currentFocus++;
      if (currentFocus >= items.length) currentFocus = 0;
      setActive(items);
    } else if (e.keyCode === 38) { // Up arrow
      e.preventDefault();
      currentFocus--;
      if (currentFocus < 0) currentFocus = items.length - 1;
      setActive(items);
    } else if (e.keyCode === 13) { // Enter
      e.preventDefault();
      if (currentFocus > -1 && items[currentFocus]) {
        items[currentFocus].click();
      }
    } else if (e.keyCode === 27) { // Escape
      closeAutocomplete();
    }
  });

  // Close on click outside
  document.addEventListener('click', function(e) {
    if (e.target !== inputElement) {
      closeAutocomplete();
    }
  });
};

// Populate US states dropdown in edit dialog
(function() {
  const states = ['AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
  const select = document.getElementById('edit-shipping-state');
  if (select) {
    states.forEach(state => {
      const option = document.createElement('option');
      option.value = state;
      option.textContent = state;
      select.appendChild(option);
    });
  }
})();

// Handle order edit form submission
document.getElementById('form-order-edit')?.addEventListener('submit', async function(e) {
  e.preventDefault();

  const orderId = document.getElementById('edit-order-id').value;
  if (!orderId) {
    alert('Order ID missing');
    return;
  }

  // Collect form data
  const formData = new FormData(this);
  const updates = {};

  // Only include fields that have values
  for (const [key, value] of formData.entries()) {
    if (key !== 'order_id' && key !== 'reason' && value) {
      updates[key] = value;
    }
  }

  const reason = formData.get('reason') || null;

  // Collect wound data from dynamic fields
  const woundsContainer = document.getElementById('edit-wounds-container');
  const woundElements = woundsContainer.querySelectorAll('[data-wound-index]');
  const woundsData = [];

  woundElements.forEach((woundEl, idx) => {
    const getField = (name) => formData.get(`wound_${idx}_${name}`) || '';

    woundsData.push({
      location: getField('location'),
      laterality: getField('laterality'),
      length_cm: parseFloat(getField('length_cm')) || 0,
      width_cm: parseFloat(getField('width_cm')) || 0,
      depth_cm: parseFloat(getField('depth_cm')) || 0,
      icd10_primary: getField('icd10_primary'),
      icd10_secondary: getField('icd10_secondary'),
      description: getField('description')
    });
  });

  // Add wounds_data to updates
  if (woundsData.length > 0) {
    updates.wounds_data = JSON.stringify(woundsData);
  }

  // Submit update
  try {
    document.getElementById('btn-order-edit-save').disabled = true;
    document.getElementById('btn-order-edit-save').textContent = 'Saving...';

    const response = await fetch('/api/portal/order.update.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        order_id: orderId,
        updates: updates,
        reason: reason
      })
    });

    const result = await response.json();

    if (result.ok) {
      alert('Order updated successfully!');
      document.getElementById('dlg-order-edit').close();
      document.getElementById('dlg-order-details')?.close();
      // Refresh current view
      if (typeof loadPage === 'function' && typeof currentPage !== 'undefined') {
        loadPage(currentPage);
      } else {
        location.reload();
      }
    } else {
      alert('Failed to update order: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    alert('Error updating order: ' + error.message);
    console.error('Full error:', error);
  } finally {
    document.getElementById('btn-order-edit-save').disabled = false;
    document.getElementById('btn-order-edit-save').textContent = 'Save Changes';
  }
});

/**
 * Open order edit dialog with pre-filled data
 */
function openOrderEditDialog(orderId) {
  // First, fetch the order data
  fetch(`?action=order.get&order_id=${encodeURIComponent(orderId)}`, {
    headers: { 'Accept': 'application/json', 'X-Requested-With': 'fetch' }
  })
    .then(r => r.json())
    .then(data => {
      if (!data.ok || !data.order) {
        alert('Failed to load order data');
        return;
      }

      const order = data.order;

      // Populate form fields
      document.getElementById('edit-order-id').value = order.id;

      // Populate dynamic wounds
      populateEditWounds(order.wounds_data || []);

      document.getElementById('edit-wound-notes').value = order.wound_notes || '';
      document.getElementById('edit-frequency').value = order.frequency || '';
      document.getElementById('edit-delivery-mode').value = order.delivery_mode || 'standard';
      document.getElementById('edit-shipping-name').value = order.shipping_name || '';
      document.getElementById('edit-shipping-address').value = order.shipping_address || '';
      document.getElementById('edit-shipping-city').value = order.shipping_city || '';
      document.getElementById('edit-shipping-state').value = order.shipping_state || '';
      document.getElementById('edit-shipping-zip').value = order.shipping_zip || '';
      document.getElementById('edit-shipping-phone').value = order.shipping_phone || '';
      document.getElementById('edit-insurer-name').value = order.insurer_name || '';
      document.getElementById('edit-member-id').value = order.member_id || '';
      document.getElementById('edit-group-id').value = order.group_id || '';
      document.getElementById('edit-payer-phone').value = order.payer_phone || '';
      document.getElementById('edit-prior-auth').value = order.prior_auth || '';
      document.getElementById('edit-reason').value = '';

      // Show/hide insurance section based on payment type
      const insuranceSection = document.getElementById('edit-insurance-section');
      if (order.payment_type === 'insurance') {
        insuranceSection.style.display = 'block';
      } else {
        insuranceSection.style.display = 'none';
      }

      // Populate wounds data
      populateEditWounds(order.wounds_data || []);

      // Open dialog
      document.getElementById('dlg-order-edit').showModal();
    })
    .catch(error => {
      alert('Error loading order: ' + error.message);
      console.error('Full error:', error);
    });
}

/**
 * Populate wounds for editing
 */
function populateEditWounds(woundsData) {
  const container = document.getElementById('edit-wounds-container');
  container.innerHTML = '';

  if (!woundsData || woundsData.length === 0) {
    addEditWound();
    return;
  }

  woundsData.forEach((wound, index) => {
    addEditWound(wound, index);
  });
}

/**
 * Add wound edit form
 */
function addEditWound(woundData = null, index = null) {
  const container = document.getElementById('edit-wounds-container');
  const woundIndex = index !== null ? index : container.children.length;

  const woundHtml = `
    <div class="p-4 border rounded bg-slate-50" data-wound-index="${woundIndex}">
      <div class="flex items-center justify-between mb-3">
        <h5 class="font-medium text-sm">Wound #${woundIndex + 1}</h5>
        ${woundIndex > 0 ? `<button type="button" onclick="removeEditWound(${woundIndex})" class="text-red-600 text-sm">Remove</button>` : ''}
      </div>

      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-medium mb-1">Location *</label>
          <select class="w-full px-2 py-1 border rounded text-sm"
            name="wound_${woundIndex}_location" required>
            <option value="">Select…</option>
            <option ${woundData?.location === 'Foot — Plantar' ? 'selected' : ''}>Foot — Plantar</option>
            <option ${woundData?.location === 'Foot — Dorsal' ? 'selected' : ''}>Foot — Dorsal</option>
            <option ${woundData?.location === 'Heel' ? 'selected' : ''}>Heel</option>
            <option ${woundData?.location === 'Ankle' ? 'selected' : ''}>Ankle</option>
            <option ${woundData?.location === 'Lower Leg — Medial' ? 'selected' : ''}>Lower Leg — Medial</option>
            <option ${woundData?.location === 'Lower Leg — Lateral' ? 'selected' : ''}>Lower Leg — Lateral</option>
            <option ${woundData?.location === 'Knee' ? 'selected' : ''}>Knee</option>
            <option ${woundData?.location === 'Thigh' ? 'selected' : ''}>Thigh</option>
            <option ${woundData?.location === 'Hip' ? 'selected' : ''}>Hip</option>
            <option ${woundData?.location === 'Buttock' ? 'selected' : ''}>Buttock</option>
            <option ${woundData?.location === 'Sacrum/Coccyx' ? 'selected' : ''}>Sacrum/Coccyx</option>
            <option ${woundData?.location === 'Abdomen' ? 'selected' : ''}>Abdomen</option>
            <option ${woundData?.location === 'Groin' ? 'selected' : ''}>Groin</option>
            <option ${woundData?.location === 'Upper Arm' ? 'selected' : ''}>Upper Arm</option>
            <option ${woundData?.location === 'Forearm' ? 'selected' : ''}>Forearm</option>
            <option ${woundData?.location === 'Hand — Dorsal' ? 'selected' : ''}>Hand — Dorsal</option>
            <option ${woundData?.location === 'Hand — Palmar' ? 'selected' : ''}>Hand — Palmar</option>
            <option ${woundData?.location === 'Elbow' ? 'selected' : ''}>Elbow</option>
            <option ${woundData?.location === 'Shoulder' ? 'selected' : ''}>Shoulder</option>
            <option ${woundData?.location === 'Back — Upper' ? 'selected' : ''}>Back — Upper</option>
            <option ${woundData?.location === 'Back — Lower' ? 'selected' : ''}>Back — Lower</option>
            <option ${woundData?.location === 'Neck' ? 'selected' : ''}>Neck</option>
            <option ${woundData?.location === 'Face/Scalp' ? 'selected' : ''}>Face/Scalp</option>
            <option ${woundData?.location === 'Other' ? 'selected' : ''}>Other</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Laterality</label>
          <select class="w-full px-2 py-1 border rounded text-sm" name="wound_${woundIndex}_laterality">
            <option value="">Select</option>
            <option value="Left" ${woundData?.laterality === 'Left' ? 'selected' : ''}>Left</option>
            <option value="Right" ${woundData?.laterality === 'Right' ? 'selected' : ''}>Right</option>
            <option value="Bilateral" ${woundData?.laterality === 'Bilateral' ? 'selected' : ''}>Bilateral</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Length (cm) *</label>
          <input type="number" step="0.1" class="w-full px-2 py-1 border rounded text-sm"
            name="wound_${woundIndex}_length_cm"
            value="${woundData?.length_cm || ''}"
            placeholder="0.0" required>
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Width (cm) *</label>
          <input type="number" step="0.1" class="w-full px-2 py-1 border rounded text-sm"
            name="wound_${woundIndex}_width_cm"
            value="${woundData?.width_cm || ''}"
            placeholder="0.0" required>
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Depth (cm)</label>
          <input type="number" step="0.1" class="w-full px-2 py-1 border rounded text-sm"
            name="wound_${woundIndex}_depth_cm"
            value="${woundData?.depth_cm || ''}"
            placeholder="0.0">
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Primary ICD-10 *</label>
          <input type="text" class="icd10-autocomplete w-full px-2 py-1 border rounded text-sm"
            name="wound_${woundIndex}_icd10_primary"
            value="${woundData?.icd10_primary || ''}"
            placeholder="Type to search ICD-10 codes..."
            autocomplete="off" required>
        </div>

        <div class="md:col-span-2">
          <label class="block text-xs font-medium mb-1">Secondary ICD-10 Codes</label>
          <input type="text" class="icd10-autocomplete w-full px-2 py-1 border rounded text-sm"
            name="wound_${woundIndex}_icd10_secondary"
            value="${woundData?.icd10_secondary || ''}"
            placeholder="Type to search ICD-10 codes..."
            autocomplete="off">
        </div>

        <div class="md:col-span-2">
          <label class="block text-xs font-medium mb-1">Wound Description</label>
          <textarea class="w-full px-2 py-1 border rounded text-sm" rows="2"
            name="wound_${woundIndex}_description"
            placeholder="Additional wound details...">${woundData?.description || ''}</textarea>
        </div>
      </div>
    </div>
  `;

  container.insertAdjacentHTML('beforeend', woundHtml);

  // Attach ICD-10 autocomplete to newly added inputs
  if (typeof window.attachIcd10Autocomplete === 'function') {
    const woundElement = container.querySelector(`[data-wound-index="${woundIndex}"]`);
    if (woundElement) {
      const icd10Inputs = woundElement.querySelectorAll('.icd10-autocomplete');
      icd10Inputs.forEach(input => {
        window.attachIcd10Autocomplete(input);
      });
    }
  }
}

/**
 * Remove wound from edit form
 */
function removeEditWound(index) {
  const container = document.getElementById('edit-wounds-container');
  const wound = container.querySelector(`[data-wound-index="${index}"]`);
  if (wound) {
    wound.remove();
    // Renumber remaining wounds
    Array.from(container.children).forEach((el, newIndex) => {
      el.setAttribute('data-wound-index', newIndex);
      el.querySelector('h5').textContent = `Wound #${newIndex + 1}`;
    });
  }
}

// Export to global scope
if (typeof window !== 'undefined') {
  window.openOrderEditDialog = openOrderEditDialog;
  window.addEditWound = addEditWound;
  window.removeEditWound = removeEditWound;
}
</script>
