<!-- Order Edit Dialog - Matches New Order Form Structure -->
<dialog id="dlg-order-edit" class="rounded-2xl w-full max-w-4xl">
  <form method="dialog" class="p-0">
    <div class="p-5 border-b flex items-center justify-between">
      <h3 class="text-lg font-semibold">Edit Order</h3>
      <button class="btn" type="button" onclick="document.getElementById('dlg-order-edit').close()">Close</button>
    </div>

    <div class="p-5 grid gap-5 max-h-[70vh] overflow-y-auto">
      <input type="hidden" id="edit-order-id">

      <!-- Product + Clinical completeness -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm">Product</label>
          <select id="edit-product" class="w-full" disabled>
            <option value="">Loading...</option>
          </select>
          <div class="text-xs text-slate-500 mt-1">Product cannot be changed after order creation</div>
        </div>

        <div>
          <label class="text-sm block mb-1">Payment</label>
          <div class="flex items-center gap-4">
            <label class="flex items-center gap-2 text-sm"><input type="radio" name="edit-paytype" value="insurance" disabled> Insurance</label>
            <label class="flex items-center gap-2 text-sm"><input type="radio" name="edit-paytype" value="self_pay" disabled> Cash</label>
          </div>
          <div class="text-xs text-slate-500 mt-1">Payment type cannot be changed</div>
        </div>

        <!-- Wounds Section (Multiple wounds supported) -->
        <div class="md:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <label class="text-sm font-medium">Wounds <span class="text-red-600">*</span></label>
            <button type="button" id="btn-edit-add-wound" class="text-sm px-3 py-2 rounded font-medium" style="background:#10b981;color:white;border:none;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,0.1);" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'" onclick="addEditWound(); return false;">+ Add Wound</button>
          </div>
          <div id="edit-wounds-container" class="space-y-4">
            <!-- Wounds will be added here dynamically -->
          </div>
        </div>

        <div>
          <label class="text-sm">Date of Last Evaluation <span class="text-red-600">*</span></label>
          <input id="edit-last-eval" type="date" class="w-full">
        </div>

        <div>
          <label class="text-sm">Start Date</label>
          <input id="edit-start-date" type="date" class="w-full">
          <div id="edit-date-validation-hint" class="text-xs mt-1" style="display:none;"></div>
        </div>

        <div>
          <label class="text-sm">Frequency (changes per week) <span class="text-red-600">*</span></label>
          <input id="edit-freq-week" type="number" min="1" max="21" value="3" class="w-full">
        </div>

        <div>
          <label class="text-sm">Quantity per Change <span class="text-red-600">*</span></label>
          <input id="edit-qty-change" type="number" min="1" value="1" class="w-full">
        </div>

        <div>
          <label class="text-sm">Duration (days) <span class="text-red-600">*</span></label>
          <input id="edit-duration-days" type="number" min="1" value="30" class="w-full">
        </div>

        <div class="md:col-span-2">
          <label class="text-sm">Patient Instructions</label>
          <input id="edit-addl-instr" class="w-full" placeholder="e.g., Saline cleanse, apply before dressing">
        </div>

        <div class="md:col-span-2">
          <label class="text-sm">Secondary Dressing</label>
          <select id="edit-secondary-dressing" class="w-full">
            <option value="">None</option>
            <option value="Dermal Wound Cleaner 8oz">Dermal Wound Cleaner 8oz bottle</option>
            <option value="Gauze - 2x2">Gauze - 2x2</option>
            <option value="Gauze - 4x4">Gauze - 4x4</option>
            <option value="Sterile Gauze 4x4">Sterile Gauze 4x4</option>
            <option value="Gauze - 6x6">Gauze - 6x6</option>
            <option value="Sterile Gauze roll">Sterile Gauze roll</option>
            <option value="Non-adherent pad">Non-adherent pad</option>
            <option value="Foam dressing">Foam dressing</option>
            <option value="Transparent film">Transparent film</option>
            <option value="Compression wrap">Compression wrap</option>
            <option value="Tubular bandage">Tubular bandage</option>
            <option value="Other">Other (specify in instructions)</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm">Clinical Notes</label>
          <textarea id="edit-ord-notes" class="w-full" rows="3" placeholder="Clinical notes" disabled></textarea>
          <div class="text-xs text-slate-500 mt-1">Clinical notes cannot be changed after creation</div>
        </div>
      </div>

      <!-- Delivery & shipping -->
      <div class="grid grid-cols-1 gap-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm block mb-1">Deliver To</label>
            <div class="flex items-center gap-4 mb-2">
              <label class="flex items-center gap-2 text-sm"><input type="radio" name="edit-deliver" value="patient" checked> Patient</label>
              <label class="flex items-center gap-2 text-sm"><input type="radio" name="edit-deliver" value="office"> Office</label>
            </div>
            <div id="edit-office-addr" class="grid grid-cols-1 md:grid-cols-2 gap-3 hidden">
              <div class="md:col-span-2"><input id="edit-ship-name" class="w-full" placeholder="Recipient / Attn"></div>
              <div><input id="edit-ship-phone" class="w-full" placeholder="Phone (10 digits)"></div>
              <div class="md:col-span-2"><input id="edit-ship-addr" class="w-full" placeholder="Street address"></div>
              <div><input id="edit-ship-city" class="w-full" placeholder="City"></div>
              <div>
                <select id="edit-ship-state" class="w-full">
                  <option value="">State</option>
                  <!-- States populated by JavaScript -->
                </select>
              </div>
              <div><input id="edit-ship-zip" class="w-full" placeholder="ZIP"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reason for changes -->
      <div>
        <label class="text-sm">Reason for Changes (Optional)</label>
        <textarea id="edit-reason" class="w-full" rows="2" placeholder="Explain why you're updating this order..."></textarea>
      </div>
    </div>

    <div class="p-5 border-t flex items-center justify-between">
      <button type="button" class="btn" onclick="document.getElementById('dlg-order-edit').close()">Cancel</button>
      <button type="button" id="btn-save-order-edit" class="btn btn-primary">Save Changes</button>
    </div>
  </form>
</dialog>

<script>
// Populate states dropdown
(function() {
  const states = ['AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
  const select = document.getElementById('edit-ship-state');
  if (select) {
    states.forEach(state => {
      const option = document.createElement('option');
      option.value = state;
      option.textContent = state;
      select.appendChild(option);
    });
  }
})();

// Toggle office address fields
document.querySelectorAll('input[name="edit-deliver"]').forEach(radio => {
  radio.addEventListener('change', function() {
    const officeAddr = document.getElementById('edit-office-addr');
    if (this.value === 'office') {
      officeAddr.classList.remove('hidden');
    } else {
      officeAddr.classList.add('hidden');
    }
  });
});

let editWoundCounter = 0;

/**
 * Add wound to edit form
 */
function addEditWound(woundData = null) {
  const container = document.getElementById('edit-wounds-container');
  const woundNum = ++editWoundCounter;

  const woundHtml = `
    <div class="p-4 border rounded bg-slate-50" id="edit-wound-${woundNum}" data-wound-num="${woundNum}">
      <div class="flex items-center justify-between mb-3">
        <h5 class="font-medium text-sm">Wound #${woundNum}</h5>
        ${container.children.length > 0 ? `<button type="button" onclick="removeEditWound(${woundNum})" class="text-red-600 text-sm hover:underline">Remove</button>` : ''}
      </div>

      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-medium mb-1">Location *</label>
          <select class="w-full px-2 py-1 border rounded text-sm" id="edit-wound-${woundNum}-location" required>
            <option value="">Select location</option>
            <option>Foot — Plantar</option>
            <option>Foot — Dorsal</option>
            <option>Heel</option>
            <option>Ankle</option>
            <option>Lower Leg — Medial</option>
            <option>Lower Leg — Lateral</option>
            <option>Knee</option>
            <option>Thigh</option>
            <option>Hip</option>
            <option>Buttock</option>
            <option>Sacrum/Coccyx</option>
            <option>Abdomen</option>
            <option>Groin</option>
            <option>Upper Arm</option>
            <option>Forearm</option>
            <option>Hand — Dorsal</option>
            <option>Hand — Palmar</option>
            <option>Elbow</option>
            <option>Shoulder</option>
            <option>Back — Upper</option>
            <option>Back — Lower</option>
            <option>Neck</option>
            <option>Face/Scalp</option>
            <option>Other</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Laterality</label>
          <select class="w-full px-2 py-1 border rounded text-sm" id="edit-wound-${woundNum}-laterality">
            <option value="">N/A</option>
            <option>Left</option>
            <option>Right</option>
            <option>Bilateral</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Length (cm) *</label>
          <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded text-sm"
            id="edit-wound-${woundNum}-length" placeholder="0.0" required>
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Width (cm) *</label>
          <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded text-sm"
            id="edit-wound-${woundNum}-width" placeholder="0.0" required>
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Depth (cm)</label>
          <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded text-sm"
            id="edit-wound-${woundNum}-depth" placeholder="0.0">
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Type</label>
          <select class="w-full px-2 py-1 border rounded text-sm" id="edit-wound-${woundNum}-type">
            <option value="">Select type</option>
            <option>Arterial ulcer</option>
            <option>Venous ulcer</option>
            <option>Diabetic ulcer</option>
            <option>Pressure ulcer</option>
            <option>Surgical wound</option>
            <option>Traumatic wound</option>
            <option>Burns</option>
            <option>Other</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Stage (if pressure ulcer)</label>
          <select class="w-full px-2 py-1 border rounded text-sm" id="edit-wound-${woundNum}-stage">
            <option value="">N/A</option>
            <option>Stage 1</option>
            <option>Stage 2</option>
            <option>Stage 3</option>
            <option>Stage 4</option>
            <option>Unstageable</option>
            <option>Deep Tissue Injury</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="block text-xs font-medium mb-1">Primary ICD-10 *</label>
          <input type="text" class="icd10-autocomplete w-full px-2 py-1 border rounded text-sm"
            id="edit-wound-${woundNum}-icd10-primary"
            placeholder="Type to search ICD-10 codes..." autocomplete="off" required>
        </div>

        <div class="md:col-span-2">
          <label class="block text-xs font-medium mb-1">Secondary ICD-10</label>
          <input type="text" class="icd10-autocomplete w-full px-2 py-1 border rounded text-sm"
            id="edit-wound-${woundNum}-icd10-secondary"
            placeholder="Additional ICD-10 codes (comma separated)" autocomplete="off">
        </div>

        <div class="md:col-span-2">
          <label class="block text-xs font-medium mb-1">Wound Notes</label>
          <textarea class="w-full px-2 py-1 border rounded text-sm" rows="2"
            id="edit-wound-${woundNum}-notes"
            placeholder="Additional wound details..."></textarea>
        </div>
      </div>
    </div>
  `;

  container.insertAdjacentHTML('beforeend', woundHtml);

  // Attach ICD-10 autocomplete
  if (typeof window.attachIcd10Autocomplete === 'function') {
    const primaryInput = document.getElementById(`edit-wound-${woundNum}-icd10-primary`);
    const secondaryInput = document.getElementById(`edit-wound-${woundNum}-icd10-secondary`);
    if (primaryInput) window.attachIcd10Autocomplete(primaryInput);
    if (secondaryInput) window.attachIcd10Autocomplete(secondaryInput);
  }

  // Populate data if provided
  if (woundData) {
    document.getElementById(`edit-wound-${woundNum}-location`).value = woundData.location || '';
    document.getElementById(`edit-wound-${woundNum}-laterality`).value = woundData.laterality || '';
    document.getElementById(`edit-wound-${woundNum}-length`).value = woundData.length_cm || '';
    document.getElementById(`edit-wound-${woundNum}-width`).value = woundData.width_cm || '';
    document.getElementById(`edit-wound-${woundNum}-depth`).value = woundData.depth_cm || '';
    document.getElementById(`edit-wound-${woundNum}-type`).value = woundData.type || '';
    document.getElementById(`edit-wound-${woundNum}-stage`).value = woundData.stage || '';
    document.getElementById(`edit-wound-${woundNum}-icd10-primary`).value = woundData.icd10_primary || '';
    document.getElementById(`edit-wound-${woundNum}-icd10-secondary`).value = woundData.icd10_secondary || '';
    document.getElementById(`edit-wound-${woundNum}-notes`).value = woundData.notes || '';
  }
}

function removeEditWound(woundNum) {
  const wound = document.getElementById(`edit-wound-${woundNum}`);
  if (wound) wound.remove();
}

/**
 * Open order edit dialog
 */
async function openOrderEditDialog(orderId) {
  try {
    const baseUrl = window.location.pathname;
    const response = await fetch(`${baseUrl}?action=order.get&order_id=${encodeURIComponent(orderId)}`, {
      headers: { 'Accept': 'application/json', 'X-Requested-With': 'fetch' }
    });

    const data = await response.json();

    if (!data.ok || !data.order) {
      alert('Failed to load order data');
      return;
    }

    const order = data.order;

    // Populate fields
    document.getElementById('edit-order-id').value = order.id;

    // Product (disabled, for reference only)
    const productSelect = document.getElementById('edit-product');
    productSelect.innerHTML = `<option value="${order.product_id}">${order.product || 'Unknown'}</option>`;
    productSelect.value = order.product_id;

    // Payment type (disabled)
    const paymentRadio = document.querySelector(`input[name="edit-paytype"][value="${order.payment_type || 'insurance'}"]`);
    if (paymentRadio) paymentRadio.checked = true;

    // Populate wounds
    editWoundCounter = 0;
    document.getElementById('edit-wounds-container').innerHTML = '';
    const wounds = order.wounds_data || [];
    if (wounds.length > 0) {
      wounds.forEach(wound => addEditWound(wound));
    } else {
      addEditWound();
    }

    // Clinical fields
    document.getElementById('edit-last-eval').value = order.last_eval_date || '';
    document.getElementById('edit-start-date').value = order.start_date || '';
    document.getElementById('edit-freq-week').value = order.frequency_per_week || 3;
    document.getElementById('edit-qty-change').value = order.qty_per_change || 1;
    document.getElementById('edit-duration-days').value = order.duration_days || 30;
    document.getElementById('edit-addl-instr').value = order.additional_instructions || '';
    document.getElementById('edit-secondary-dressing').value = order.secondary_dressing || '';
    document.getElementById('edit-ord-notes').value = order.wound_notes || '';

    // Delivery
    const deliverRadio = document.querySelector(`input[name="edit-deliver"][value="${order.delivery_mode || 'patient'}"]`);
    if (deliverRadio) {
      deliverRadio.checked = true;
      deliverRadio.dispatchEvent(new Event('change'));
    }

    document.getElementById('edit-ship-name').value = order.shipping_name || '';
    document.getElementById('edit-ship-phone').value = order.shipping_phone || '';
    document.getElementById('edit-ship-addr').value = order.shipping_address || '';
    document.getElementById('edit-ship-city').value = order.shipping_city || '';
    document.getElementById('edit-ship-state').value = order.shipping_state || '';
    document.getElementById('edit-ship-zip').value = order.shipping_zip || '';

    document.getElementById('edit-reason').value = '';

    // Open dialog
    document.getElementById('dlg-order-edit').showModal();

  } catch (error) {
    alert('Error loading order: ' + error.message);
    console.error(error);
  }
}

/**
 * Save order changes
 */
document.getElementById('btn-save-order-edit')?.addEventListener('click', async function() {
  const orderId = document.getElementById('edit-order-id').value;
  if (!orderId) {
    alert('Order ID missing');
    return;
  }

  // Collect wounds data
  const woundsContainer = document.getElementById('edit-wounds-container');
  const woundElements = woundsContainer.querySelectorAll('[data-wound-num]');
  const woundsData = [];

  for (const woundEl of woundElements) {
    const num = woundEl.dataset.woundNum;
    woundsData.push({
      location: document.getElementById(`edit-wound-${num}-location`)?.value || '',
      laterality: document.getElementById(`edit-wound-${num}-laterality`)?.value || '',
      length_cm: parseFloat(document.getElementById(`edit-wound-${num}-length`)?.value) || 0,
      width_cm: parseFloat(document.getElementById(`edit-wound-${num}-width`)?.value) || 0,
      depth_cm: parseFloat(document.getElementById(`edit-wound-${num}-depth`)?.value) || 0,
      type: document.getElementById(`edit-wound-${num}-type`)?.value || '',
      stage: document.getElementById(`edit-wound-${num}-stage`)?.value || '',
      icd10_primary: document.getElementById(`edit-wound-${num}-icd10-primary`)?.value || '',
      icd10_secondary: document.getElementById(`edit-wound-${num}-icd10-secondary`)?.value || '',
      notes: document.getElementById(`edit-wound-${num}-notes`)?.value || ''
    });
  }

  const updates = {
    wounds_data: JSON.stringify(woundsData),
    last_eval_date: document.getElementById('edit-last-eval').value,
    start_date: document.getElementById('edit-start-date').value,
    frequency_per_week: parseInt(document.getElementById('edit-freq-week').value),
    qty_per_change: parseInt(document.getElementById('edit-qty-change').value),
    duration_days: parseInt(document.getElementById('edit-duration-days').value),
    additional_instructions: document.getElementById('edit-addl-instr').value,
    secondary_dressing: document.getElementById('edit-secondary-dressing').value,
    delivery_mode: document.querySelector('input[name="edit-deliver"]:checked')?.value || 'patient',
    shipping_name: document.getElementById('edit-ship-name').value,
    shipping_phone: document.getElementById('edit-ship-phone').value,
    shipping_address: document.getElementById('edit-ship-addr').value,
    shipping_city: document.getElementById('edit-ship-city').value,
    shipping_state: document.getElementById('edit-ship-state').value,
    shipping_zip: document.getElementById('edit-ship-zip').value
  };

  const reason = document.getElementById('edit-reason').value.trim() || null;

  try {
    this.disabled = true;
    this.textContent = 'Saving...';

    const response = await fetch('?action=order.update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        order_id: orderId,
        updates: updates,
        reason: reason
      })
    });

    const result = await response.json();

    if (result.ok) {
      alert('Order updated successfully!');
      document.getElementById('dlg-order-edit').close();
      // Refresh page
      if (typeof loadPage === 'function' && typeof currentPage !== 'undefined') {
        loadPage(currentPage);
      } else {
        location.reload();
      }
    } else {
      alert('Failed to update order: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    alert('Error updating order: ' + error.message);
    console.error(error);
  } finally {
    this.disabled = false;
    this.textContent = 'Save Changes';
  }
});

// ICD-10 Autocomplete Function (reuse from main form)
window.attachIcd10Autocomplete = window.attachIcd10Autocomplete || function(inputElement) {
  if (!inputElement) return;

  let autocompleteList = null;
  let currentFocus = -1;
  let abortController = null;

  function createAutocompleteList() {
    if (autocompleteList) return autocompleteList;

    autocompleteList = document.createElement('div');
    autocompleteList.className = 'icd10-autocomplete-list';
    autocompleteList.style.cssText = `
      position: absolute;
      z-index: 9999;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      max-height: 200px;
      overflow-y: auto;
      display: none;
    `;

    inputElement.parentNode.style.position = 'relative';
    inputElement.parentNode.appendChild(autocompleteList);

    return autocompleteList;
  }

  function closeAutocomplete() {
    if (autocompleteList) {
      autocompleteList.style.display = 'none';
      autocompleteList.innerHTML = '';
    }
    currentFocus = -1;
  }

  inputElement.addEventListener('input', async function() {
    const value = this.value.trim();

    if (value.length < 2) {
      closeAutocomplete();
      return;
    }

    if (abortController) abortController.abort();
    abortController = new AbortController();

    try {
      const response = await fetch(`/api/icd10_search.php?term=${encodeURIComponent(value)}`, {
        signal: abortController.signal
      });

      const data = await response.json();

      if (data.success && data.results && data.results.length > 0) {
        const list = createAutocompleteList();
        list.innerHTML = '';
        list.style.display = 'block';

        const rect = inputElement.getBoundingClientRect();
        const parentRect = inputElement.parentNode.getBoundingClientRect();
        list.style.top = (rect.bottom - parentRect.top) + 'px';
        list.style.left = (rect.left - parentRect.left) + 'px';
        list.style.width = rect.width + 'px';

        data.results.forEach((result) => {
          const item = document.createElement('div');
          item.style.cssText = `
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
            border-bottom: 1px solid #f3f4f6;
          `;

          item.innerHTML = `
            <div style="font-weight: 500;">${result.code}</div>
            <div style="color: #6b7280; font-size: 0.75rem;">${result.description}</div>
          `;

          item.addEventListener('click', function() {
            inputElement.value = `${result.code} - ${result.description}`;
            closeAutocomplete();
          });

          item.addEventListener('mouseenter', function() {
            this.style.background = '#3b82f6';
            this.style.color = 'white';
          });

          item.addEventListener('mouseleave', function() {
            this.style.background = '';
            this.style.color = '';
          });

          list.appendChild(item);
        });
      } else {
        closeAutocomplete();
      }
    } catch (error) {
      if (error.name !== 'AbortError') {
        console.error('ICD-10 search error:', error);
      }
    }
  });

  document.addEventListener('click', function(e) {
    if (e.target !== inputElement) {
      closeAutocomplete();
    }
  });
};

// Export to global scope
if (typeof window !== 'undefined') {
  window.openOrderEditDialog = openOrderEditDialog;
  window.addEditWound = addEditWound;
  window.removeEditWound = removeEditWound;
}
</script>
