<!-- Order Edit Dialog -->
<dialog id="dlg-order-edit" class="rounded-2xl w-full max-w-4xl">
  <form method="dialog" class="p-0" id="form-order-edit">
    <div class="p-5 border-b flex items-center justify-between bg-slate-50">
      <h3 class="text-lg font-semibold">Edit Order</h3>
      <button class="btn" type="button" onclick="document.getElementById('dlg-order-edit').close()">Cancel</button>
    </div>

    <div class="p-6 max-h-[70vh] overflow-y-auto">
      <input type="hidden" id="edit-order-id" name="order_id">

      <!-- Wound Details Section -->
      <div class="mb-6">
        <h4 class="font-semibold text-md mb-3 pb-2 border-b">Wound Details</h4>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Wound Location *</label>
            <input
              type="text"
              id="edit-wound-location"
              name="wound_location"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="e.g., Left Foot, Plantar Surface"
              required
            >
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Wound Laterality</label>
            <select
              id="edit-wound-laterality"
              name="wound_laterality"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select laterality</option>
              <option value="Left">Left</option>
              <option value="Right">Right</option>
              <option value="Bilateral">Bilateral</option>
              <option value="N/A">N/A</option>
            </select>
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-sm font-medium mb-1">Clinical Notes</label>
          <textarea
            id="edit-wound-notes"
            name="wound_notes"
            rows="3"
            class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
            placeholder="Additional wound description, measurements, or clinical observations..."
          ></textarea>
        </div>
      </div>

      <!-- Treatment Frequency Section -->
      <div class="mb-6">
        <h4 class="font-semibold text-md mb-3 pb-2 border-b">Treatment Information</h4>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Treatment Frequency *</label>
            <select
              id="edit-frequency"
              name="frequency"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              required
            >
              <option value="">Select frequency</option>
              <option value="1x per week">1x per week</option>
              <option value="2x per week">2x per week</option>
              <option value="3x per week">3x per week</option>
              <option value="Daily">Daily</option>
              <option value="Every other day">Every other day</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Delivery Mode</label>
            <select
              id="edit-delivery-mode"
              name="delivery_mode"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
            >
              <option value="standard">Ship to Patient</option>
              <option value="office">Deliver to Office</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Shipping Information Section -->
      <div class="mb-6" id="edit-shipping-section">
        <h4 class="font-semibold text-md mb-3 pb-2 border-b">Shipping Address</h4>
        <div class="grid gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Recipient Name *</label>
            <input
              type="text"
              id="edit-shipping-name"
              name="shipping_name"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Full name"
            >
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Street Address *</label>
            <input
              type="text"
              id="edit-shipping-address"
              name="shipping_address"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Street address"
            >
          </div>

          <div class="grid md:grid-cols-3 gap-4">
            <div class="md:col-span-1">
              <label class="block text-sm font-medium mb-1">City *</label>
              <input
                type="text"
                id="edit-shipping-city"
                name="shipping_city"
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                placeholder="City"
              >
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">State *</label>
              <select
                id="edit-shipping-state"
                name="shipping_state"
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Select state</option>
                <!-- States will be populated by JavaScript -->
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">ZIP Code *</label>
              <input
                type="text"
                id="edit-shipping-zip"
                name="shipping_zip"
                pattern="\d{5}"
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                placeholder="12345"
              >
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Phone Number</label>
            <input
              type="tel"
              id="edit-shipping-phone"
              name="shipping_phone"
              pattern="\d{10}"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="1234567890 (10 digits)"
            >
          </div>
        </div>
      </div>

      <!-- Insurance Information Section -->
      <div class="mb-6" id="edit-insurance-section">
        <h4 class="font-semibold text-md mb-3 pb-2 border-b">Insurance Information</h4>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Insurance Provider</label>
            <input
              type="text"
              id="edit-insurer-name"
              name="insurer_name"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Insurance company name"
            >
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Member ID</label>
            <input
              type="text"
              id="edit-member-id"
              name="member_id"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Member/Policy ID"
            >
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Group Number</label>
            <input
              type="text"
              id="edit-group-id"
              name="group_id"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Group number"
            >
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Payer Phone</label>
            <input
              type="tel"
              id="edit-payer-phone"
              name="payer_phone"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Insurance contact number"
            >
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Prior Authorization Number</label>
            <input
              type="text"
              id="edit-prior-auth"
              name="prior_auth"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
              placeholder="Prior auth # (if applicable)"
            >
          </div>
        </div>
      </div>

      <!-- Revision Reason -->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-1">Reason for Changes (Optional)</label>
        <textarea
          id="edit-reason"
          name="reason"
          rows="2"
          class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
          placeholder="Brief explanation of why you're updating this order..."
        ></textarea>
      </div>
    </div>

    <div class="p-5 border-t bg-slate-50 flex justify-end gap-3">
      <button
        type="button"
        class="btn"
        onclick="document.getElementById('dlg-order-edit').close()"
      >
        Cancel
      </button>
      <button
        type="submit"
        class="btn btn-primary"
        id="btn-order-edit-save"
      >
        Save Changes
      </button>
    </div>
  </form>
</dialog>

<script>
// Populate US states dropdown in edit dialog
(function() {
  const states = ['AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
  const select = document.getElementById('edit-shipping-state');
  if (select) {
    states.forEach(state => {
      const option = document.createElement('option');
      option.value = state;
      option.textContent = state;
      select.appendChild(option);
    });
  }
})();

// Handle order edit form submission
document.getElementById('form-order-edit')?.addEventListener('submit', async function(e) {
  e.preventDefault();

  const orderId = document.getElementById('edit-order-id').value;
  if (!orderId) {
    alert('Order ID missing');
    return;
  }

  // Collect form data
  const formData = new FormData(this);
  const updates = {};

  // Only include fields that have values
  for (const [key, value] of formData.entries()) {
    if (key !== 'order_id' && key !== 'reason' && value) {
      updates[key] = value;
    }
  }

  const reason = formData.get('reason') || null;

  // Submit update
  try {
    document.getElementById('btn-order-edit-save').disabled = true;
    document.getElementById('btn-order-edit-save').textContent = 'Saving...';

    const response = await fetch('/api/portal/order.update.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        order_id: orderId,
        updates: updates,
        reason: reason
      })
    });

    const result = await response.json();

    if (result.ok) {
      alert('Order updated successfully!');
      document.getElementById('dlg-order-edit').close();
      document.getElementById('dlg-order-details')?.close();
      // Refresh current view
      if (typeof loadPage === 'function' && typeof currentPage !== 'undefined') {
        loadPage(currentPage);
      } else {
        location.reload();
      }
    } else {
      alert('Failed to update order: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    alert('Error updating order: ' + error.message);
    console.error('Full error:', error);
  } finally {
    document.getElementById('btn-order-edit-save').disabled = false;
    document.getElementById('btn-order-edit-save').textContent = 'Save Changes';
  }
});

/**
 * Open order edit dialog with pre-filled data
 */
function openOrderEditDialog(orderId) {
  // First, fetch the order data
  fetch(`?action=order.get&order_id=${encodeURIComponent(orderId)}`, {
    headers: { 'Accept': 'application/json', 'X-Requested-With': 'fetch' }
  })
    .then(r => r.json())
    .then(data => {
      if (!data.ok || !data.order) {
        alert('Failed to load order data');
        return;
      }

      const order = data.order;

      // Populate form fields
      document.getElementById('edit-order-id').value = order.id;
      document.getElementById('edit-wound-location').value = order.wound_location || '';
      document.getElementById('edit-wound-laterality').value = order.wound_laterality || '';
      document.getElementById('edit-wound-notes').value = order.wound_notes || '';
      document.getElementById('edit-frequency').value = order.frequency || '';
      document.getElementById('edit-delivery-mode').value = order.delivery_mode || 'standard';
      document.getElementById('edit-shipping-name').value = order.shipping_name || '';
      document.getElementById('edit-shipping-address').value = order.shipping_address || '';
      document.getElementById('edit-shipping-city').value = order.shipping_city || '';
      document.getElementById('edit-shipping-state').value = order.shipping_state || '';
      document.getElementById('edit-shipping-zip').value = order.shipping_zip || '';
      document.getElementById('edit-shipping-phone').value = order.shipping_phone || '';
      document.getElementById('edit-insurer-name').value = order.insurer_name || '';
      document.getElementById('edit-member-id').value = order.member_id || '';
      document.getElementById('edit-group-id').value = order.group_id || '';
      document.getElementById('edit-payer-phone').value = order.payer_phone || '';
      document.getElementById('edit-prior-auth').value = order.prior_auth || '';
      document.getElementById('edit-reason').value = '';

      // Show/hide insurance section based on payment type
      const insuranceSection = document.getElementById('edit-insurance-section');
      if (order.payment_type === 'insurance') {
        insuranceSection.style.display = 'block';
      } else {
        insuranceSection.style.display = 'none';
      }

      // Open dialog
      document.getElementById('dlg-order-edit').showModal();
    })
    .catch(error => {
      alert('Error loading order: ' + error.message);
      console.error('Full error:', error);
    });
}

// Export to global scope
if (typeof window !== 'undefined') {
  window.openOrderEditDialog = openOrderEditDialog;
}
</script>
